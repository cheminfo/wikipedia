'use strict';define(["jquery","modules/default/defaultview","src/util/util","src/util/api","quill","quillImageResizeModule","lodash","src/main/grid","quillImageDropModule"],function(a,b,c,d,e,f,g){"use strict";function h(){this._id=c.getNextUniqueId()}function i(a){return"all"===a?[[{header:[1,2,3,4,!1]}],[{font:[]}],[{size:["small",!1,"large","huge"]}],[{color:[]},{background:[]}],["bold","italic","underline","strike"],["link","image","video","code-block","blockquote","code"],[{align:[]}],[{list:"ordered"},{list:"bullet"}],[{script:"sub"},{script:"super"}],[{indent:"-1"},{indent:"+1"}],[{direction:"rtl"}],["formula"],["clean"]]:"light"===a?[[{header:[1,2,3,4,!1]}],[{color:[]}],["bold","italic"],["link","image","blockquote"],[{align:[]}],[{list:"bullet"}],[{script:"sub"},{script:"super"}]]:"minimal"===a?[[{header:[1,2,3,4,!1]},{color:[]},"bold","italic",{align:[]},{list:"bullet"}]]:void 0}return e.register("modules/ImageResize",f.default),e.imports["formats/link"].PROTOCOL_WHITELIST.includes("blob")||e.imports["formats/link"].PROTOCOL_WHITELIST.push("blob"),a.extend(!0,h.prototype,b,{init:function(){var a=this;this.debounce=this.module.getConfiguration("debouncing"),this.storeInView=this.module.getConfigurationCheckbox("storeInView","yes"),this.module.currentWord="",this.module.shortcuts=[],this.valueChanged=g.debounce(function(){a.module.controller.valueChanged.apply(a.module.controller,arguments)},this.debounce)},inDom:function(){this.initEditor()},initEditor:function(){c.loadCss("./components/quill/quill.core.css").then(()=>c.loadCss("./components/quill/quill.snow.css")).then(()=>c.loadCss("node_modules/katex/dist/katex.min.css")).then(()=>{var b=this.module.definition.richtext||"";this.$content=a(`
            <style>
              ${this.module.getConfiguration("css")}
            </style>
            <div id="${this._id}" class="quill_editor ${this.module.getConfiguration("className")}" />
          `),this.dom=a("<div class=\"quill_wrapper\" />"),this.dom.bind("keypress",a=>this._listenForShortcuts(a)),this.dom.bind("keydown",a=>"Shift"===a.key?void 0:"Tab"===a.key?void this._listenForShortcuts({key:"",isTab:!0}):void(1<a.key.length&&(this.module.currentWord=""))),this.$content.appendTo(this.dom),this.module.getDomContent().html(this.dom);const c=!this.module.getConfigurationCheckbox("editable","isEditable");this.instance=new e(`#${this._id}`,{modules:{clipboard:{matchVisual:!1},imageDrop:!0,ImageResize:{},formula:!0,toolbar:!c&&i(this.module.getConfiguration("toolbarMode"))},placeholder:"Start composing here...",readOnly:c,theme:"snow"}),this.storeInView&&(this.instance.setContents(b),this.module.controller.valueChanged(b)),this.instance.on("text-change",()=>{this.valueChanged(this.instance.getContents())}),this.resolveReady()})},exportToHTML:function(){const a=this.dom[0].querySelector(".ql-editor");d.domToHTML(a).then(a=>{d.copyHTMLToClipboard(a)})},update:{html:function(a){this.module.data=a,this.clear(),this.mode="html",this.instance.setContents(this.instance.clipboard.convert(a.get()))},quill:function(a){this.module.data=a,this.clear(),this.mode="quill",this.instance.setContents(a.get())},shortcuts:function(a){(!a||1>a.length)&&(this.module.shortcuts=[]),a=JSON.parse(JSON.stringify(a)),Array.isArray(a)&&(this.module.shortcuts=a.filter(a=>a.key&&(a.html||a.text)))}},blank:{html:function(){this.clear()},quill:function(){this.clear()},shortcuts:function(){this.module.shortcuts=[]}},clear(){const a=this.instance.getLength();this.instance.deleteText(0,a)},onActionReceive:{insertHtml:function(a){this.instance.focus(),a+="";const b=this.instance.getSelection();this.instance.deleteText(b.index,b.length),this.instance.clipboard.dangerouslyPasteHTML(b.index,a)},insertText:function(a){this.instance.focus(),a+="";const b=this.instance.getSelection();this.instance.deleteText(b.index,b.length);let c=document.createElement("div");c.appendChild(document.createTextNode(a)),this.instance.clipboard.dangerouslyPasteHTML(b.index,c.innerHTML)}},_listenForShortcuts:function(a){if(this.module.shortcuts&&!(1>this.module.shortcuts.length))if("_"!==a.key&&("A">a.key||"Z"<a.key)&&("a">a.key||"z"<a.key)&&("0">a.key||"9"<a.key)){let b=this.module.shortcuts.filter(a=>a.key===this.module.currentWord)[0];if(this.module.currentWord="",!b)return;let c=this.instance.getSelection(),d=b.key.length+(a.isTab||0),e=c.index-d;this.instance.deleteText(e,d),b.text?this.instance.insertText(e,b.text):b.html&&(this.instance.clipboard.dangerouslyPasteHTML(e,b.html),this.instance.setSelection(this.instance.getSelection().index+1,0))}else this.module.currentWord+=a.key}}),h});
