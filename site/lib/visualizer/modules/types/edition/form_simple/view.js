"use strict";define(["modules/default/defaultview","src/util/datatraversing","src/util/api","lib/formcreator/formcreator","lodash"],function(a,b,c,d,e){function f(){}return $.extend(!0,f.prototype,a,{init:function(){this.dom=$("<div />"),this.module.getDomContent().html(this.dom),this.callback=null},inDom:function(){function a(){if(!c.lockEvents){var a,b,d=new DataObject(this.getValue(),!0);c.formValue=d;var e,f=c.module.getDataFromRel("input_object"),g=c.module.getConfiguration("structure")||[],h=new DataObject;if(f)if(c.module.getConfiguration("replaceObj")){for(a=0,b=g.length;b>a;a++)e=g[a].groups.general[0].searchOnField[0],f.setChild(e,c.form.sectionElements.main[0].groupElements.main[0].fieldElements[g[a].groups.general[0].name[0]][0].value,[c.module.getId()]);c.module.model.dataTriggerChange(f)}else for(a=0,b=g.length;b>a;a++)e=g[a].groups.general[0].searchOnField[0],h.setChild(e,c.form.sectionElements.main[0].groupElements.main[0].fieldElements[g[a].groups.general[0].name[0]][0].value);else h=d;return h}}var b,c=this,f=this.module.getConfiguration("structure")||[],g=this.module.getConfiguration("tpl_file"),h=this.module.getConfiguration("trigger"),i=this.module.getConfiguration("tpl_html"),j={},k={sections:{main:{groups:{main:{options:{type:"list",multiple:!1},fields:d.makeStructure(f)}}}}};b=g?$.get(g,{}):i;var l=function(){var b=a.call(this);c.module.controller.formTriggered(b)},m=function(){var b=a.call(this);c.module.controller.valueChanged(b)};$.when(b).done(function(a){a='<form><div style="position: relative;" class="form-sections-wrapper form-section-section-container"><div class="form-section" data-form-sectionname="main"><div class="form-section-group-container"><div class="form-group" data-form-groupname="main">'+a+"</div></div></div></div></form>";var b=d.makeForm();switch(h){case"btn":case"both":var f=c.module.getConfiguration("btnLabel");b.addButton(f,{color:"blue"},$.proxy(l,b));case"change":var g=c.module.getConfiguration("debounce");j.onValueChanged=g>0?e.debounce(m,g):m}b.init(j),b.setStructure(k),b.onStructureLoaded().done(function(){b.fill({})}),b.onLoaded().done(function(){b.setTpl(a),c.dom.html(b.makeDomTpl()),b.inDom(),b.dom.submit(function(a){a.preventDefault()}),l.call(b),c.resolveReady()}),c.form=b})},update:{input_object:function(a){var b=this;this.newValue(a),this.module.model.dataListenChange(a,function(){b.newValue(this)},"input_object")}},newValue:function(a){var b,c=this,d=this.module.getConfiguration("structure")||[];c.lockEvents=!0,c.nb=0;for(var e=0,f=d.length;f>e;e++)b=d[e].groups.general[0].searchOnField[0],function(b,e){c.nb++,a.getChild(e,!0).then(function(a){c.form.sectionElements.main[0].groupElements.main[0].fieldElements[d[b].groups.general[0].name[0]][0].value=a?a.get?a.get():a.toString():"",c.nb--,0==c.nb&&(c.lockEvents=!1)})}(e,b)}}),f});