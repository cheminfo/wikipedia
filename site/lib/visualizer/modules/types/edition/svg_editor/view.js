'use strict';require.config({paths:{svgsanitize:"lib/svg-edit/sanitize"},shim:{svgsanitize:["lib/svg-edit/svgedit","lib/svg-edit/browser","lib/svg-edit/svgutils"],"lib/svg-edit/svgutils":["lib/svg-edit/browser","lib/svg-edit/svgtransformlist","lib/svg-edit/units"],"lib/svg-edit/svgtransformlist":["lib/svg-edit/browser"]}}),define(["require","src/util/api","lodash","modules/default/defaultview","src/util/debug","src/util/typerenderer","src/util/util","src/util/datatraversing","lib/svg-edit/embedapi","svgsanitize"],function(a,b,c,d,e,f){"use strict";function g(){var a=this;this.svgCanvas=null,this.iframeLoaded=$.Deferred(),this.iframeLoaded.done(function(){a.svgCanvas.zoomChanged(window,"canvas")})}var h=c.throttle(function(){function a(a){c[0].module.getConfigurationCheckbox("saveSvg","yes")&&(c[0].module.definition.configuration.groups.group[0].svgcode=[a]),c[0].module.controller.onChange(a)}function b(b,c){return c?void e.error("Unable to get svg from iframe"):void a(b)}var c=arguments;if(c[0]._configCheckBox("editable","isEditable"))setTimeout(function(){c[0].svgCanvas.getSvgString()(b)},0);else{var d=c[0].dom.clone(),f=d[0].getAttribute("viewBox").split(" ");d.attr("width",f[2]).attr("height",f[3]).removeAttr("viewBox"),d=d.wrap("<p/>").parent().html(),a(d)}},1e3),j=["animate","set","animateMotion","animateColor","animateTransform"],l={begin:"indefinite",options:{clearOnEnd:!1,persistOnEnd:!1,clearAnimationTagsOnEnd:!1,clearAnimationTagsBeforeBegin:!1}},m=["options","tag","attributes"],n=["click","dblclick","mouseenter","mouseleave"],o={},p={},q={};return $.extend(!0,g.prototype,d,{_renderSvg:function(a){var b=this;return a=a?a.get()+"":b.module.getConfiguration("svgcode"),a?new Promise(c=>{if(this._configCheckBox("editable","isEditable"))this.dom&&this.dom.remove(),this.svgCanvas=null,this.dom=$(`<iframe src="lib/svg-edit/svg-editor.html?extensions=ext-xdomain-messaging.js${window.location.href.replace(/\?(.*)$/,"&$1")}"></iframe>`),this.module.getDomContent().html(this.dom),this.dom.bind("load",function(){var a=b.dom[0];return b.svgCanvas=new EmbeddedSVGEdit(a),b.iframeDoc=a.contentDocument||a.contentWindow.document,b.svgEditor=a.contentWindow.svgEditor,a.contentWindow.svgedit.options={},b.svgCanvas.bind("changed",function(){b.svgEditor.showSaveWarning=!1,b._saveSvg()}),b._loadSvg(),b.iframeLoaded.resolve(),b.onResize(),c()});else{var d=b.module.getDomContent();return f.render(d,{type:"svg",value:a}).catch(function(){d.html("<svg></svg>")}).then(function(){b.dom=d.find("svg")}).then(c)}}).then(()=>{this.modifySvgFromArray(this.queuedSvgModifier,!0)}):Promise.resolve()},init:function(){this._renderSvg().then(()=>{this.resolveReady()})},onResize:function(){this._configCheckBox("editable","isEditable")&&this.dom&&(this.dom.parent().css({overflow:"hidden"}),this.dom.height(this.height).width(this.width),this.svgCanvas&&this.svgCanvas.zoomChanged(window,"canvas"))},update:{svgModifier:function(a){this.queuedSvgModifier=a,this.modifySvgFromArray(this.queuedSvgModifier,!0)},svgInput:function(a){this._renderSvg(a).then(this._saveSvg.bind(this))}},addAnimation:function(a,b){var d=this,f=$([]);if(b.attributes){a.attr("id");if(b.tag=b.tag||"animate",-1!==j.indexOf(b.tag)){Array.isArray(b.attributes)||(b.attributes=[b.attributes]),b=c.defaults(b,l);var g=d.getHighlightId(a),h={};for(var i in b)-1===m.indexOf(i)&&(h[i]=c.cloneDeep(b[i]));for(let d=0;d<b.attributes.length;d++){b.attributes[d]=c.defaults(b.attributes[d],h),a.each(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",b.tag);for(var c in b.attributes[d]){var e=b.attributes[d][c];e="function"==typeof e?e.call():e,a.setAttributeNS(null,c,e)}$(this).append(a)});var k=a.children(":last-child");f=f.add(k)}f.each(function(c,h){this.addEventListener("endEvent",function(){if(q[g]=!1,b.options.persistOnEnd&&("animate"===b.tag?a.attr(this.getAttribute("attributeName"),this.getAttribute("to")):e.warn("Could not persist animation")),b.options.clearAnimationTags&&d.$getAnimationTags(a).remove(),b.options.clearOnEnd){var c=b.options.clearOnEnd.timeout||0;setTimeout(function(){$(h).remove(),d._saveSvg()},c)}else;}),this.addEventListener("repeatEvent",function(){}),this.addEventListener("beginEvent",function(){b.options.clearAnimationTagsBeforeBegin&&(d.$getAnimationTags(a).not(f).remove(),p[g]=0,q[g]=!0)}),"indefinite"===this.getAttribute("begin")&&this.beginElement()})}}},addAnimations:function(a,b){if(Array.isArray(b))for(var c=0;c<b.length;c++)this.addAnimation(a,b[c]);else this.addAnimation(a,b)},setAttributesOneByOne:function(a,b){for(const c in b)"function"==typeof b[c]?a.each(function(){this.setAttribute(c,b[c].call())}):a.attr(c,b[c])},removeStyleProperties:function(a,b){a.each(function(){for(var a in b)this.style.removeProperty(a)})},modifySvgFromArray:function(a,b){var c=this;if(a){Array.isArray(a)||(a=[a]),this.$svgcontent=this._configCheckBox("editable","isEditable")?$(c.iframeDoc).find("#svgcontent"):c.dom,c.module._data=[];for(var d=0;d<a.length;d++)this.modifySvgFromObject(a[d],b);c._saveSvg()}},modifySvgFromObject:function(d,f){function g(){$(this).css("cursor","pointer"),l.module.controller.onHover(d.info||{})}function h(){$(this).css("cursor","default")}function i(){l.module.controller.onClick(d.info||{})}function j(b){if(!q[a]){var c={};c.tag="animateTransform",c.options={clearOnEnd:!1,persistOnEnd:!1},c.attributes={attributeName:"transform",type:"scale",from:"1.0",dur:"0.2s",additive:"sum",accumulate:"sum",fill:"freeze"},b&&0===p[a]?(c.options.clearAnimationTags=!1,c.attributes.to="1.25",p[a]++):!b&&1===p[a]&&(c.options.clearAnimationTags=!1,c.attributes.to="0.8",p[a]--),l.addAnimation(r,c)}}var l=this,m=d.selector;if(m){var o="string"==typeof d._highlight;d.info&&(l.module._data=d.info);var r,s=this.$svgcontent;if(r=s.find(m),0===r.length&&"#"!==m[0]&&(r=s.find(`#${m}`)),0===r.length)return void e.warn("The svg element to modify was not found",m);if(d.innerVal&&r.html(d.innerVal),d.attributes&&!d.animation)c.some(d.attributes,a=>"function"==typeof a)?this.setAttributesOneByOne(r,d.attributes):r.attr(d.attributes),l.removeStyleProperties(r,d.attributes);else if(d.animation&&!d.attributes)l.addAnimations(r,d.animation);else if(d.attributes&&d.animation&&!d.animation.attributes){for(var t in d.animation.attributes=[],d.attributes){var k={};k.attributeName=t,k.to=d.attributes[t],d.animation.attributes.push(k)}delete d.attributes,l.addAnimations(r,d.animation)}else d.attributes&&d.animation&&d.animation.attributes&&(r.attr(d.attributes),l.removeStyleProperties(r,d.attributes),l.addAnimations(r,d.animation));if(f){if(o){var a=l.getHighlightId(r);b.killHighlight(a),b.listenHighlight({_highlight:d._highlight},j,!1,a),p[a]=p[a]||0}(function(a){a.off("mouseenter.svgeditor.varout").off("mouseleave.svgeditor.varout").off("click.svgeditor.varout"),d.info&&a.on("mouseenter.svgeditor.varout",g).on("mouseleave.svgeditor.varout",h).on("click.svgeditor.varout",i);for(var b=0;b<n.length;b++)d.hasOwnProperty(n[b])&&function(b){a.off(b),a.on(b,function(){d[b].selector||(d[b].selector=d.selector),l.modifySvgFromArray(d[b],!1)})}(n[b])})(r)}}},getHighlightId:function(a){a.map(function(){return this.getAttribute("id")}).toArray().join(",")},getDom:function(){return this.dom},_loadSvg:function(){var a=this.module.getConfiguration("svgcode");this.svgCanvas.setSvgString(a),this.module.controller.onChange(a)},_saveSvg:function(){h(this)},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&c.find(this.module.getConfiguration(a),a=>a===b)},memorizeAnim:function(a,b){b&&a.attributes&&a.attributes.to&&a.attributes.attributeName&&(o[b]=o[b]||{},o[b][a.attributes.attributeName]=o[b][a.attributes.attributeName]||{},o[b][a.attributes.attributeName].to=a.attributes.to)},rememberAnim:function(a,b){a.attributes&&!a.attributes.from&&b&&o[b]&&o[b][a.attributes.attributeName]&&o[b][a.attributes.attributeName].to&&(a.attributes.from=o[b][a.attributes.attributeName].to)},$getAnimationTags:function(a){for(var b,c=0;c<j.length;c++)b=0==c?a.find(j[c]):b.add(a.find(j[c]));return b}}),g});
