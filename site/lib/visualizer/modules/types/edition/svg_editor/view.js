requirejs.config({paths:{svgsanitize:"lib/svg-edit-2.7/sanitize"},shim:{svgsanitize:["lib/svg-edit-2.7/svgedit","lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgutils"],"lib/svg-edit-2.7/svgutils":["lib/svg-edit-2.7/browser","lib/svg-edit-2.7/svgtransformlist","lib/svg-edit-2.7/units"],"lib/svg-edit-2.7/svgtransformlist":["lib/svg-edit-2.7/browser"]}}),define(["require","src/util/api","lodash","modules/default/defaultview","src/util/typerenderer","src/util/util","src/util/datatraversing","lib/svg-edit-2.7/embedapi","svgsanitize"],function(a,b,c,d,e){function f(){var a=this;this.svgCanvas=null,this.iframeLoaded=$.Deferred(),this.iframeLoaded.done(function(){a.svgCanvas.zoomChanged(window,"canvas")})}var g=c.throttle(function(){function a(a){c[0].module.definition.configuration.groups.group[0].svgcode=[a],c[0].module.controller.onChange(a)}function b(b,c){return c?void console.error("Unable to get svg from iframe"):void a(b)}var c=arguments;if(c[0]._configCheckBox("editable","isEditable"))setTimeout(function(){c[0].svgCanvas.getSvgString()(b)},0);else{var d=c[0].dom.clone(),e=d[0].getAttribute("viewBox").split(" ");d.attr("width",e[2]).attr("height",e[3]).removeAttr("viewBox"),d=d.wrap("<p/>").parent().html(),a(d)}},1e3),h=["animate","set","animateMotion","animateColor","animateTransform"],i={begin:"indefinite",options:{clearOnEnd:!1,persistOnEnd:!1,clearAnimationTagsOnEnd:!1,clearAnimationTagsBeforeBegin:!1}},j=["options","tag","attributes"],l=["click","dblclick","mouseenter","mouseleave"],m={},n={},o={};return f.prototype=$.extend(!0,{},d,{init:function(){var a=this;if(this._configCheckBox("editable","isEditable"))this.dom&&this.dom.remove(),this.svgCanvas=null,this.dom=$('<iframe src="lib/svg-edit-2.7/svg-editor.html?extensions=ext-xdomain-messaging.js'+window.location.href.replace(/\?(.*)$/,"&$1")+'"></iframe>'),this.module.getDomContent().html(this.dom),this.dom.bind("load",function(){var b=a.dom[0];a.svgCanvas=new EmbeddedSVGEdit(b),a.iframeDoc=b.contentDocument||b.contentWindow.document,a.svgEditor=b.contentWindow.svgEditor,b.contentWindow.svgedit.options={},a.svgCanvas.bind("changed",function(){a.svgEditor.showSaveWarning=!1,a._saveSvg()}),a._loadSvg(),a.iframeLoaded.resolve(),a.resolveReady(),a.onResize()});else{var b=e.toScreen({type:"svg",value:a.module.getConfiguration("svgcode")},this.module);b.always(function(b){a.dom=b||$("<svg></svg>"),a.module.getDomContent().html(a.dom),a.resolveReady()})}},inDom:function(){},onResize:function(){this._configCheckBox("editable","isEditable")&&this.dom&&(this.dom.height(this.height).width(this.width),this.svgCanvas&&this.svgCanvas.zoomChanged(window,"canvas"))},blank:function(){},update:{svgModifier:function(a){var b=this;b.modifySvgFromArray(a,!0)}},addAnimation:function(a,b){var d=this,e=$([]);if(b.attributes){{a.attr("id")}if(b.tag=b.tag||"animate",-1!==h.indexOf(b.tag)){Array.isArray(b.attributes)||(b.attributes=[b.attributes]),b=c.defaults(b,i);var f=d.getHighlightId(a),g={};for(k in b)-1===j.indexOf(k)&&(g[k]=c.cloneDeep(b[k]));for(var l=0;l<b.attributes.length;l++){b.attributes[l]=c.defaults(b.attributes[l],g),a.each(function(){var a=document.createElementNS("http://www.w3.org/2000/svg",b.tag);for(var c in b.attributes[l]){var d=b.attributes[l][c];d="function"==typeof d?d.call():d,a.setAttributeNS(null,c,d)}$(this).append(a)});var m=a.children(":last-child");e=e.add(m)}e.each(function(){this.addEventListener("endEvent",function(){if(o[f]=!1,b.options.persistOnEnd&&("animate"===b.tag?a.attr(this.getAttribute("attributeName"),this.getAttribute("to")):console.warn("Could not persist animation")),b.options.clearAnimationTags&&d.$getAnimationTags(a).remove(),b.options.clearOnEnd){var c=this,e=b.options.clearOnEnd.timeout||0;setTimeout(function(){$(c).remove(),d._saveSvg()},e)}}),this.addEventListener("repeatEvent",function(){}),this.addEventListener("beginEvent",function(){b.options.clearAnimationTagsBeforeBegin&&(d.$getAnimationTags(a).not(e).remove(),n[f]=0,o[f]=!0)}),"indefinite"===this.getAttribute("begin")&&this.beginElement()})}}},addAnimations:function(a,b){if(Array.isArray(b))for(var c=0;c<b.length;c++)this.addAnimation(a,b[c]);else this.addAnimation(a,b)},setAttributesOneByOne:function(a,b){for(var c in b)"function"==typeof b[c]?a.each(function(){this.setAttribute(c,b[c].call())}):a.attr(c,b[c])},removeStyleProperties:function(a,b){a.each(function(){for(var a in b)this.style.removeProperty(a)})},modifySvgFromArray:function(a,b){var c=this;Array.isArray(a)||(a=[a]),this.$svgcontent=this._configCheckBox("editable","isEditable")?$(c.iframeDoc).find("#svgcontent"):c.dom,c.module._data=[];for(var d=0;d<a.length;d++)this.modifySvgFromObject(a[d],b);c._saveSvg()},modifySvgFromObject:function(a,d){function e(){$(this).css("cursor","pointer"),i.module.controller.onHover(a.info||{})}function f(){$(this).css("cursor","default")}function g(){i.module.controller.onClick(a.info||{})}function h(a){if(!o[s]){var b={};b.tag="animateTransform",b.options={clearOnEnd:!1,persistOnEnd:!1},b.attributes={attributeName:"transform",type:"scale",from:"1.0",dur:"0.2s",additive:"sum",accumulate:"sum",fill:"freeze"},a&&0===n[s]?(b.options.clearAnimationTags=!1,b.attributes.to="1.25",n[s]++):a||1!==n[s]||(b.options.clearAnimationTags=!1,b.attributes.to="0.8",n[s]--),i.addAnimation(m,b)}}var i=this,j=a.selector;if(j){var k="string"==typeof a._highlight;a.info&&(i.module._data=a.info);var m,p=this.$svgcontent;if(m=p.find(j),0===m.length&&(m=p.find("#"+j)),0===m.length)return void console.warn("The svg element to modify was not found",j);if(a.innerVal&&m.html(a.innerVal),a.attributes&&!a.animation)c.any(a.attributes,function(a){return"function"==typeof a})?this.setAttributesOneByOne(m,a.attributes):m.attr(a.attributes),m.each(function(){}),i.removeStyleProperties(m,a.attributes);else if(a.animation&&!a.attributes)i.addAnimations(m,a.animation);else if(a.attributes&&a.animation&&!a.animation.attributes){a.animation.attributes=[];for(var q in a.attributes){var r={};r.attributeName=q,r.to=a.attributes[q],a.animation.attributes.push(r)}delete a.attributes,i.addAnimations(m,a.animation)}else a.attributes&&a.animation&&a.animation.attributes&&(m.attr(a.attributes),i.removeStyleProperties(m,a.attributes),i.addAnimations(m,a.animation));if(d){if(k){var s=i.getHighlightId(m);b.killHighlight(s),b.listenHighlight({_highlight:a._highlight},h,!1,s),n[s]=n[s]||0}!function(b){b.off("mouseenter.svgeditor.varout").off("mouseleave.svgeditor.varout").off("click.svgeditor.varout"),a.info&&b.on("mouseenter.svgeditor.varout",e).on("mouseleave.svgeditor.varout",f).on("click.svgeditor.varout",g);for(var c=0;c<l.length;c++)a.hasOwnProperty(l[c])&&!function(c){b.off(c),b.on(c,function(){a[c].selector||(a[c].selector=a.selector),i.modifySvgFromArray(a[c],!0)})}(l[c])}(m)}}},getHighlightId:function(a){a.map(function(){return this.getAttribute("id")}).toArray().join(",")},_clearEventCallbacks:function(a){for(var b=0;b<a.length;b++)if(a.selector)for(var c=0;c<l.length;c++)$(a.selector).off(l[c]+".svgeditor.svgmodifier")},getDom:function(){return this.dom},_loadSvg:function(){var a=this.module.getConfiguration("svgcode");this.svgCanvas.setSvgString(a),this.module.controller.onChange(a)},_saveSvg:function(){g(this)},_configCheckBox:function(a,b){return this.module.getConfiguration(a)&&c.find(this.module.getConfiguration(a),function(a){return a===b})},memorizeAnim:function(a,b){b&&a.attributes&&a.attributes.to&&a.attributes.attributeName&&(m[b]=m[b]||{},m[b][a.attributes.attributeName]=m[b][a.attributes.attributeName]||{},m[b][a.attributes.attributeName].to=a.attributes.to)},rememberAnim:function(a,b){a.attributes&&!a.attributes.from&&b&&m[b]&&m[b][a.attributes.attributeName]&&m[b][a.attributes.attributeName].to&&(a.attributes.from=m[b][a.attributes.attributeName].to)},$getAnimationTags:function(a){for(var b,c=0;c<h.length;c++)b=0===c?a.find(h[c]):b.add(a.find(h[c]));return b}}),f});