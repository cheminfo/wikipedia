'use strict';define(["jquery","modules/default/defaultview","lib/twigjs/twig","src/util/debug","src/util/api","lodash","src/util/Form","src/util/util"],function(a,b,c,d,e,f,g,h){"use strict";function i(){}return a.extend(!0,i.prototype,b,{init(){this._changedJpaths=new Set;var b=this.module.getConfiguration("template");this.hasTemplate=new Promise(a=>{this._resolveTemplate=a}),b&&this._resolveTemplate(),this.dom=a("<div>").css({height:"100%",width:"100%","user-select":this.module.getConfigurationCheckbox("selectable","yes")?"text":"none"});var d=this.module.getConfiguration("debouncing");if(d)var e=f.debounce(this.submitChange,d).bind(this);else e=this.submitChange.bind(this);var h=this.submit.bind(this);this.form&&this.form.unbind(),this.form=new g(this.dom,{keepFormValueIfDataUndefined:this.module.getConfigurationCheckbox("formOptions","keepFormValueIfDataUndefined")}),this.form.onChange(e),this.form.onSubmit(h),this._values=new DataObject,this.renderPromise||(this.renderPromise=Promise.resolve()),this.renderPromise.then(()=>{this.template=c.twig({data:this.module.getConfiguration("template")})})},inDom(){this.module.getDomContent().html(this.dom),this.resolveReady(),this.rerender()},rerender(){this.render(()=>{this.resetForm()})},clearForm(){this.form.clear()},exportToHTML:function(){e.domToHTML(this.dom[0]).then(a=>{e.copyHTMLToClipboard(a)})},setForm(a){this.form.setData(a)},resetForm(){this.form.setData(this.currentForm)},setStyle(){var a=this.styleObject;if(a){a instanceof Array||(a=[a]);for(let d=0;d<a.length;d++){if(a[d].input)var b=`input[name="${a[d].input}"],textarea[name="${a[d].input}"],select[name="${a[d].input}"]`;else b=a[d].selector;var c=this.dom.find(b);a[d].attributes&&c.attr(a[d].attributes),a[d].style&&c.css(a[d].style)}}},getForm(){return this.currentForm=this.form.getData(!1)},submitChange(a,b){a=a||{target:{}};const c={data:this.getForm()};return this._lastChanged&&(c.previousData=this._lastChanged),this._lastChanged=c.data,c.jpath=a.target.name&&a.target.name.split("."),a.target.name&&this._changedJpaths.add(a.target.name),this.module.controller.onFormChanged(c,b),null},submit(){const a={data:this.getForm(),jpaths:Array.from(this._changedJpaths).map(a=>a.split("."))};this._changedJpaths.clear(),this._lastSubmit&&(a.previousData=this._lastSubmit),this._lastSubmit=a.data,this.module.controller.onFormSubmitted(a)},blank:{value(){return this.renderPromise=this.renderPromise.then(()=>{this.dom.hide(),this.getForm()}).catch(()=>{d.warn("Error")}),null},tpl(){return this.renderPromise=this.renderPromise.then(()=>{this.dom.hide(),this.getForm(),this.template=c.twig({data:""})}),null},form:h.noop,style:h.noop},update:{value(a,b){this._values[b]=DataObject.resurrect(a.get()),this.rerender(),this.module.getConfigurationCheckbox("formOptions","rerenderIfValueChanges")&&this.render(()=>this.fillForm(!0))},tpl(a){var b=a.get().toString();return this.renderPromise.then(()=>(this.template=c.twig({data:b}),this.rerender(),null)).then(()=>this._resolveTemplate()).catch(a=>{d.info(`Problem with template: ${a}`)}).then(()=>this.submitChange())},async form(a,b){this.formName=b,this.formObject=a,this.hasTemplate.then(()=>{this.fillForm(!0),this.module.getConfigurationCheckbox("formOptions","rerenderIfFormValueChanges")&&this.rerender()})},style(a){this.styleObject=a.resurrect(),this.rerender()}},onActionReceive:{clearForm:function(a){this.clearForm(),a&&this.submitChange()},setForm:function(a){if(!a.data)throw new Error("setForm invalid arguments. Must be object with data property.");this.setForm(a.data),a.submitChange&&this.submitChange()}},fillForm(a){const b=this.form.setData(this.formObject);b.forEach(a=>this._changedJpaths.add(a)),this.submitChange(null,a)},render(a){var b=this;return this.renderPromise=this.renderPromise.then(()=>{this.formName&&(this._values[this.formName]=this.formObject);var c=this.template.renderAsync(this._values);this.dom.html(c.html);const d=c.render().then(function(){a&&a(),b.setStyle(),b.module.controller.onRendered(b.dom.html())});return this.dom.show(),d}).catch(a=>{d.warn("Error rendering twig template",a)}),this.renderPromise}}),i});
