'use strict';define(["modules/default/defaultview","src/util/util","src/util/api","src/util/domdeferred","src/util/datatraversing","src/util/context"],function(a,b,c,d,e,f){"use strict";function g(){}return $.extend(!0,g.prototype,a,{init:function(){var c,d=this,e=this.module.getConfiguration("toggle");this.domTable=$("<table />",{cellpadding:0,cellspacing:0}).css({width:"100%"}),this.domHead=$("<thead />").appendTo(this.domTable),this.domBody=$("<tbody />").appendTo(this.domTable),this.selected=[],this.domTable.on("mouseenter","tbody tr",function(){var a=$(this).index();isNaN(a)||d.module.controller.lineHover(d.module.data,a)}).on("mouseleave","tbody tr",function(){var a=$(this).index();isNaN(a)||d.module.controller.lineOut(d.module.data,a)}).on("click","tr",function(){var a=$(this);if(d.module.controller.lineClick(d.module.data,a.index()),e){"single"==e&&void 0!==d.selected[0]&&(d.module.controller.onToggleOff(d.module.data,d.selected[0]),a.parent().children().eq(d.selected[0]).toggleClass("toggled"),d.selected=[]);var b=a.index();a.hasClass("toggled")?d.module.controller.onToggleOff(d.module.data,b):d.module.controller.onToggleOn(d.module.data,b),a.toggleClass("toggled"),d.selected.push(b)}}).on("click","th",function(){var e=$(this).attr("data-jpath-number"),g=d.module.getDataFromRel("list");c&&c.col===e?c.col===e&&(c.asc=!c.asc,c.span.toggleClass("up")):(c&&d.domTable.find(`th[data-jpath-number="${c.col}"] .sort`).remove(),c={asc:!0,col:e,span:$("<div class=\"sort up\"></div>")},d.domTable.find(`th[data-jpath-number="${c.col}"]`).append(c.span)),g.sort(function(g,a){return(c.asc?1:-1)*(d.jpaths[f[e].jpath](g)>d.jpaths[f[e].jpath](a)?1:-1)}),d.module.model.dataTriggerChange(g),d.blank.list.call(d),d.update.list.call(d,g)}),this.dom=this.domTable,this.module.getDomContent().html(this.dom),this.onResize();var f=this.module.getConfiguration("colsjPaths"),g=f.length,a=0;this.colsjPaths=f,this.jpaths={};for(var h="<tr>";a<g;a++)f[a].jpath&&(b.addjPathFunction(this.jpaths,f[a].jpath),h+=`<th data-jpath-number="${a}">${f[a].name}</th>`);h+="</tr>";var i=this.module.getConfiguration("colorjPath");i&&(this.colorjpath=b.makejPathFunction(i)),this.domHead.html(h),this.resolveReady()},unload:function(){this.module.getDomContent().empty()},applyFilterToRow:function(a,b){this.filter&&this.filter(this.jqGrid,this.elements[a],b)},blank:{list:function(){if(this.domBody&&this.domBody.empty(),!!this.module.data){var a,b=this.module.data.length;for(a=0;a<b;a++)this.module.data[a]&&this.module.data[a].unbindChange&&this.module.data[a].unbindChange(this.module.getId())}}},update:{list:function(a){if("string"!==a.type&&a){this.selected=[],this.elements=a;var b=this,d=this.module.getConfiguration("nbLines")||20,e="",g=0,h=a.get().length;for(this.module.data=a,g=0;g<h;g++)e+=this.buildElement(a.getChildSync([g]),g);this.domBody.html(e),this.timeout&&window.clearTimeout(this.timeout),this.timeout=window.setTimeout(function(){for(c.killHighlight(b.module.getId()),g=0;g<h;g++)(function(a){c.listenHighlight(b.module.data[a],function(c){b.doHighlight(a,c)},!1,b.module.getId());var d=b.domBody.find(`#${b.module.getId()}_${a}`);b.module.model.dataListenChange(b.module.data.get(a),function(){d.replaceWith(d=$(b.buildElement(this,a,!0)))},"list"),b.module.data.get(a).removable&&f.listen(d.get(0),[["<li><a><span class=\"ui-icon ui-icon-close\"></span> Remove</a></li>",function(){b.onActionReceive.removeRowById.call(b,a)}]])})(g)},1e3),this.list=!0,this.showList=!1,this.updateVisibility()}},showList:function(a){Array.isArray(a)&&(this.showList=a,this.updateVisibility())}},updateVisibility:function(){if(this.showList&&this.list)for(var a,b=this.showList,c=b.length,d=`${this.module.getId()}_`,e=0;e<c;e++)a=document.getElementById(d+e),b[e]?a.removeAttribute("style"):a.setAttribute("style","display:none")},buildElement:function(a,b){var c,d,f,g=this.colsjPaths,h="",i=g.length;for(h+="<tr",this.colorjpath&&(f=this.colorjpath(a),Array.isArray(f)&&(3===f.length?f=`rgb(${f.join(",")})`:f=`rgba(${f.join(",")})`),h+=` style="background-color: ${f};"`),h+=` id="${this.module.getId()}_${b}" `,h+=">",c=0;c<i;c++)g[c].jpath&&(h+="<td>",d=e.get(this.getValue(e.get(a),g[c].jpath)),"undefined"==typeof d&&(d=""),h+=d,h+="</td>");return h+="</tr>",h},doHighlight:function(a,b){let c=this.domBody.find("tr").eq(a);c[b?"addClass":"removeClass"]("ci-highlight")},getValue:function(a,b){return this.jpaths[b]?this.jpaths[b](a):""},getDom:function(){return this.dom},onActionReceive:{addRow:function(a){if(this.elements=this.elements||[],!(-1<this.module.getDataFromRel("list").indexOf(a))){this.module.getDataFromRel("list").push(a);var b=this.elements.length-1,c=this.buildElement(a,b);this.domBody.append(c)}},removeRow:function(a){this.onActionReceive.removeRowById.call(this,this.module.getDataFromRel("list").indexOf(a))},removeRowById:function(a){if(!(0>a)){var b=this.module.getDataFromRel("list").splice(a,1);b[0].unbindChange(this.module.getId());var c;-1<(c=this.selected.indexOf(a))&&this.selected.splice(c,1),this.domBody.children().eq(a).remove()}},toggleOff:function(a){var b=this.module.getDataFromRel("list").indexOf(a);-1==b||(this.module.controller.onToggleOff(this.module.data,b),this.domBody.children().eq(b).removeClass("toggled"))},toggleOn:function(a){var b=this.module.getDataFromRel("list").indexOf(a);if(-1!=b){var c=this.module.getConfiguration("toggle"),d=this;"single"==c&&void 0!==d.selected[0]&&(d.module.controller.onToggleOff(d.module.data,d.selected[0]),d.domBody.children().eq(d.selected[0]).toggleClass("toggled"),d.selected=[]),d.selected.push(b),this.module.controller.onToggleOn(this.module.data,b),this.domBody.children().eq(b).addClass("toggled")}},scrollTo:function(a){var b=this.module.getDataFromRel("list").indexOf(a);if(-1!=b){var c=this.domBody.children().eq(b).get();c.scrollIntoView()}}},exportToTabDelimited:function(){if(this.colsjPaths){for(var a=[],b=this.elements.length,c=this.colsjPaths,d=[],f=0;f<c.length;f++)d.push(c[f].name);a.push(d.join("\t"));for(let d=0;d<b;d++){for(var g=[],f=0;f<c.length;f++)e.getValueFromJPath(this.elements[d],c[f].jpath).done(function(a){g.push(a)});a.push(g.join("\t"))}return a.join("\r\n")}}}),g});
