'use strict';define(["src/util/api","src/util/debug","modules/default/defaultview","src/util/util","src/util/ui","lodash","bowser","components/jquery.panzoom/dist/jquery.panzoom","components/jquery-mousewheel/jquery.mousewheel"],function(a,b,c,d,e,f,g){"use strict";function h(){this.lastTransform=[1,0,0,1,0,0]}function i(a){if(6!==a.length)throw new Error("getCssTransform expects array of length 6");return`matrix(${a.join(",")})`}var j=.5;return $.extend(!0,h.prototype,c,{init:function(){this.currentPromise=Promise.resolve(),this.toHide=this.toHide||{},this.transforms=this.transforms||{};var a=this;this.dom||(this._id=d.getNextUniqueId(),this.dom=$(`<div id="${this._id}"></div>`).css("height","100%").css("width","100%"),this.module.getDomContent().html(this.dom)),this.dom.off("mouseleave"),this.dom.on("mouseleave",function(){a.highlightOff()}),this.images=[],this.state="done"},blank:{picture:function(a){this.clearImage(a)},image:function(a){this.clearImage(a)},svg:function(a){this.clearImage(a)}},inDom:function(){var a=this.module.getConfiguration("transformThrottling");this.module.controller.setTransformThrottling(a),this.resolveReady()},update:{picture:function(a,b){return this.doImage(b,a,{},!0)},svg:function(a,b){this.doSvg(b,a,{},!0)},image:function(a,b){this.doImage(b,a,{},!0)}},clearImages:function(){if(!this.images)return void(this.images=[]);for(var a=0;a<this.images.length;a++)this.images[a].$panzoomEl.panzoom("destroy");this.dom.html(""),this.images=[]},clearImage:function(a){this.currentPromise=this.currentPromise.then(()=>{var b=f.findIndex(this.images,b=>b.name===a);-1===b||(this.images[b].$panzoomEl.panzoom("destroy"),this.images[b].$parent.remove(),this.images.slice(b,1))})},doImage:function(a,c,d,e){var f=this;return this.currentPromise=this.currentPromise.then(function(){return f.addImage(a,c,d)}).then(function(){f.panzoomMode(a),f.reorderImages(),e&&(f.processHighlights(),f.listenHighlights())},function(a){b.warn("panzoom: image failed to load",a)}),this.currentPromise},doSvg:function(a,b,c,d){return c=c||{},c.isSvg=!0,this.doImage(a,b,c,d)},reorderImages:function(){for(var a=0;a<this.images.length;a++)this.images[a].$panzoomEl.css("z-index",parseInt(this.images[a].conf.order,10)||a)},addImage:function(b,c,d){var e=this;return new Promise(function(g,h){function j(a){p&&p.remove(),h(a)}function k(){s.type=n,s.name=l.variable,s.$panzoomEl=m.find(".panzoom"),s.$parent=m,s.$img=o,s.conf=l,s.transform=null,"__highlight__"===s.name&&m.css({"pointer-events":"none"}),e.dom.append(m),"svg"===n?(s.width=this.width(),s.height=this.height()):(s.width=this.width,s.height=this.height);var a=s.conf.scaling;if("maxIfLarge"===a&&(s.width>e.width||s.height>e.height?a="max":a="no"),"max"===a?s.width/s.height>e.width/e.height?(s.f=e.width/s.width,s.transform=i([s.f,0,0,s.f,0,0])):(s.f=e.height/s.height,s.transform=i([s.f,0,0,s.f,0,0])):"no"==a&&(s.f=1,s.transform=i([s.f,0,0,s.f,0,0])),"asHighlight"===a&&e.himg.f){var b=[e.himg.f,0,0,e.himg.f,e.highlightImage.shiftx*e.himg.f,e.highlightImage.shifty*e.himg.f];s.transform=i(b)}r||e.images.push(s),p&&p.remove(),o.css({transform:s.transform,transformOrigin:"0 0",display:"block"}),o.show(),g()}void 0===c&&(c=a.getData(b));var l=f.find(e.module.getConfiguration("img"),function(a){return a.variable===b});if(l=e._completeConf(l,b,d),!l.variable)throw new Error("panzoom: conf is expected to have a variable name");var m=e.dom.find(`#${e.getImageDomId(b)}`);m.find(".panzoom").panzoom("destroy");var n,o,p,q=!!d&&(d.isSvg||"svg"===c.type);0===m.length&&"__highlight__"===b?(m=e.newCanvasDom(b),o=$(e.highlightImage.canvas),m.find(".panzoom").append(o),n="canvas"):"__highlight__"===b?(m.find("canvas").remove(),o=$(e.highlightImage.canvas),m.find(".panzoom").append(o),n="canvas"):0===m.length&&q?(m=e.newSvgDom(b),o=$(c.get()+""),m.find(".panzoom").append(o),n="svg"):q?(p=m.find("svg"),o=$(c.get()+""),m.find(".panzoom").append(o),n="svg"):0===m.length?(m=e.newImageDom(b),o=m.find("img"),n="image"):(p=m.find("img"),o=$("<img style=\"display: none;\"/>"),m.find(".panzoom").append(o),n="image");var r=!1,s=f.find(e.images,function(a){return a.name===b});return s&&(r=!0),s=s||{},e.toHide&&e.toHide[l.variable]?(p&&p.hide(),o.remove(),g()):void(o.css("opacity",l.opacity).addClass(l.rendering),"__highlight__"===b?k.call(e.highlightImage.canvas):q?k.call(o):o.on("load",k).on("error",j).attr("src",c.get()+""))})},processHighlights:function(){var c;this.highlights=null;for(var e=0;e<this.images.length;e++)"__highlight__"!==this.images[e].name&&a.getData(this.images[e].name)._highlightArray&&(c=this.images[e]);if(c){var f=a.getData(c.name);if(f._highlightArray.length!==c.width*c.height)return void b.warn("Panzoom: unexpected highlight length");this._highlightArray=f._highlightArray,void 0===this._highlightArray||d.isArray(this._highlightArray)||(b.warn("_highlightArray should be an Array"),this._highlightArray=void 0),this._highlight=f._highlight||[],"Array"!==d.objectToString(this._highlight)&&(this._highlight=[this._highlight]),this.himg=c,this.highlights={};for(var g=new Map,e=0;e<this._highlight.length;e++)g.set(this._highlight[e],!0);for(e=0;e<f._highlightArray.length;e++){var j=f._highlightArray[e],h=e%c.width,k=0|e/c.width;void 0!==j&&g.get(j)&&(this.highlights[j]?this.highlights[j].data.push(e):this.highlights[j]={data:[e],shiftx:h,shifty:k,shiftX:h,shiftY:k},h<this.highlights[j].shiftx?this.highlights[j].shiftx=h:h>this.highlights[j].shiftX&&(this.highlights[j].shiftX=h),k<this.highlights[j].shifty?this.highlights[j].shifty=k:k>this.highlights[j].shiftY&&(this.highlights[j].shiftY=k))}var l=Object.keys(this.highlights);for(e=0;e<l.length;e++){var m=l[e];this.highlights[m].width=this.highlights[m].shiftX-this.highlights[m].shiftx+1,this.highlights[m].height=this.highlights[m].shiftY-this.highlights[m].shifty+1}}},listenHighlights:function(){var b=this;if(a.killHighlight(this.module.getId()),!!this.highlights){var c=Object.keys(this.highlights);b._highlighted=[];for(var d=0;d<c.length;d++)(function(d){a.listenHighlight({_highlight:c[d]},function(a,c,d,e){Array.isArray(c)||(c=[c]),b._highlighted=a?f(b._highlighted).push(c).flatten().uniq().value():f.filter(b._highlighted,function(a){return-1===c.indexOf(a)}),b._drawHighlight(e)},!1,b.module.getId())})(d)}},_drawHighlight:function(a){var b=this;this._highlighted&&this._highlighted.length?(this.toHide.__highlight__=!1,this.highlightImage=this._createHighlight(this._highlighted)):(this.toHide.__highlight__=!0,this.highlightImage=this.highlightImage||{},this.highlightImage.dataUrl="data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw=="),this.doImage("__highlight__").then(function(){const c=b.module.getConfiguration("highlightStrategy");if("none"!==c&&a!==b.module.getId()){var d=b.highlightImage.canvas.width,e=b.highlightImage.canvas.height,f=b.highlightImage.shiftx,g=b.highlightImage.shifty;f=Math.max(f-j*d,0),g=Math.max(g-j*e,0);var h;"panzoom"===c?(h=Math.min(b.himg.width/d*j,b.himg.height/e*j),h=Math.max(1,h)):h=b.lastTransform[0];var i=[h,0,0,h,-h*b.himg.f*f,-h*b.himg.f*g];b.setTransform(i,!0)}})},newImageDom:function(a){return $(`<div class="ci-panzoom-parent" id="${this.getImageDomId(a)}"><div class="panzoom"><img style="display: none;"/></div></div>`)},newCanvasDom:function(a){return $(`<div class="ci-panzoom-parent" id="${this.getImageDomId(a)}"><div class="panzoom"></div></div>`)},newSvgDom:function(a){return $(`<div class="ci-panzoom-parent" id="${this.getImageDomId(a)}"><div class="panzoom"></div></div>`)},getImageDomId:function(a){return`ci-panzoom-image-${a}`},panzoomMode:function(a){function b(a,b,d){for(var e=0;e<c.images.length;e++){var f=c.images[e].$img[0].getBoundingClientRect(),g={x:0|(a.clientX-f.left)*c.images[e].width/f.width,y:0|(a.clientY-f.top)*c.images[e].height/f.height};0<=g.x&&g.x<c.images[e].width&&0<=g.y&&g.y<c.images[e].height&&(0==e&&(d.x=g.x,d.y=g.y),b[c.images[e].name]=g)}}var c=this,d=0,e=this.images.length;if(a){var g=f.findIndex(c.images,function(b){return b.name===a});d=-1===g?void 0:g,e=g+1}for(var h=d;h<e;h++){if(c.images[h].$panzoomEl.panzoom({increment:.1,maxScale:100,minScale:1e-6,duration:0,startTransform:"none",onEnd:function(){"pan"===c.state&&$(this).css("cursor","pointer")}}).css("cursor","pointer"),c.lastTransform){var j=c.images[h].$panzoomEl.panzoom("instance");j.setMatrix(c.lastTransform)}c.images[h].$panzoomEl.off("panzoompan"),c.images[h].$panzoomEl.on("panzoompan",function(a,b){c.lastTransform=b.getMatrix(),c.module.controller.transformChanged(c.lastTransform);for(var d=0;d<c.images.length;d++){"done"===c.state&&(c.images[d].$panzoomEl.css("cursor","move"),c.state="pan");var e=c.images[d].$panzoomEl.panzoom("instance");e!==b&&e.setMatrix(c.lastTransform)}})}c.dom.off("mousewheel.focal"),c.dom.on("mousewheel.focal",function(a){a.preventDefault();var b=1;if(0<c.images.length){var d=c.images[0].$panzoomEl.panzoom("getMatrix")[0];b=.2*d}var e=a.delta||a.originalEvent.wheelDelta,f=e?0>e:0<a.originalEvent.deltaY;c.images[0].$panzoomEl.panzoom("zoom",f,{increment:b,animate:!1,focal:a}),c.lastTransform=c.images[0].$panzoomEl.panzoom("getMatrix"),c.module.controller.transformChanged(c.lastTransform);for(var g,h=1;h<c.images.length;h++)g=c.images[h].$panzoomEl.panzoom("instance"),g.setMatrix(c.lastTransform);c.rerender()}),c.dom.off("click.panzoom"),c.dom.on("click.panzoom",function(a){if("pan"===c.state)return void(c.state="done");c.state="done",$(this).css("cursor","pointer");var d={shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,altKey:a.altKey},e=Object.assign({},d),f={};if(b(a,f,e),3!==Object.keys(e).length&&c.module.controller.clickedPixel(e),0!==Object.keys(f).length){for(var g=Object.keys(f),h=0;h<g.length;h++)Object.assign(f[g[h]],d);c.module.controller.allClickedPixels(f)}}),c.dom.off("mousemove.panzoom"),c.dom.on("mousemove.panzoom",function(a){var d={shiftKey:a.shiftKey,ctrlKey:a.ctrlKey,altKey:a.altKey};if("pan"!==c.state){var e={},g=Object.assign({},d);b(a,e,g);var h=Object.keys(g);if(3<h.length&&!f.isEqual(DataObject.resurrect(c.lastHoverPixel),g)&&(c.module.controller.hoverPixel(g),c.lastHoverPixel=g,c.highlightOn(g)),3===h.length&&c.highlightOff(),3<h.length&&void 0===c._hl&&c.highlightOn(g),!f.isEmpty(e)&&!f.isEqual(DataObject.resurrect(c.lastAllHoverPixels),e)){for(var j=Object.keys(e),k=0;k<j.length;k++)Object.assign(e[j[k]],d);c.module.controller.allHoverPixels(e),c.lastAllHoverPixels=e}}}),this.dom.off("dblclick"),this.dom.dblclick(function(){for(var a=0;a<c.images.length;a++)c.images[a].$panzoomEl.panzoom("reset"),0==a&&(c.lastTransform=c.images[a].$panzoomEl.panzoom("getMatrix"),c.module.controller.transformChanged(c.lastTransform))})},setTransform:function(a,b){this.lastTransform=a,b||this.module.controller.transformChanged(this.lastTransform);for(var c,d=0;d<this.images.length;d++)c=this.images[d].$panzoomEl.panzoom("instance"),c.setMatrix(this.lastTransform)},_createHighlight:function(a){if(!this.highlights)return null;Array.isArray(a)||(a=[a]);for(var b,c=this.highlights[a[0]].shiftx,d=this.highlights[a[0]].shifty,e=this.highlights[a[0]].shiftx,f=this.highlights[a[0]].shiftY,g=0;g<a.length;g++)b=a[g],c=Math.min(c,this.highlights[b].shiftx),d=Math.min(d,this.highlights[b].shifty),e=Math.max(e,this.highlights[b].shiftX),f=Math.max(f,this.highlights[b].shiftY);var k=document.createElement("canvas"),l=f-d+1,m=e-c+1;k.height=l,k.width=m;for(var n,o=k.getContext("2d"),p=o.createImageData(m,l),q=p.data,g=0;g<l*m;g++)n=4*g,q[n]=0|255,q[n+1]=255,q[n+2]=153,q[n+3]=0;for(var r,s=0;s<a.length;s++)for(r=a[s],g=0;g<this.highlights[r].data.length;g++){n=this.highlights[r].data[g];var t=n%this.himg.width,u=0|n/this.himg.width,v=t-c,w=u-d;q[4*(w*m+v)+3]=255}return o.putImageData(p,0,0),{canvas:k,shiftx:c,shifty:d}},highlightOn:function(a){var b=this;if(b._highlightArray){var c=a.x+b.himg.width*a.y,d=b._highlightArray[c];void 0===d?b._hl&&b.highlightOff():b._hl!==d&&(b.module.model.highlightId(b._hl,0),b.module.model.highlightId(d,1),b._hl=d)}},highlightOff:function(){void 0!==this._hl&&(this.module.model.highlightId(this._hl,0),this._hl=void 0)},rerender:f.debounce(function(){for(var a=0;a<this.images.length;a++)(this.images[a].conf.rerender&&-1<this.images[a].conf.rerender.indexOf("yes")||"crisp-edges"===this.images[a].conf.rendering&&g.chrome)&&this.doImage(this.images[a].name)},300),onResize:function(){this.doAllImages()},doAllImages:function(){for(var a=0;a<this.images.length;a++)"svg"===this.images[a].type?this.doSvg(this.images[a].name):this.doImage(this.images[a].name)},getDom:function(){return this.dom},export:function(){var a=this.images.filter(a=>"image"===a.type||"svg"===a.type),b=a.map(a=>{var b;return b="image"===a.type?a.$img[0].src:`data:image/svg+xml;base64,${d.toB64(a.$img.html())}`,{name:a.name+"",link:{type:"downloadLink",value:b,_options:{filename:a.name+""}}}});e.choose(b,{columns:[{id:"name",name:"name",field:"name"},{id:"link",name:"link",field:"link"}],idField:"name",noSelect:!0,noConfirmation:!0})},onActionReceive:{hide:function(a){var b;b="string"==typeof a?a:a.name,this.toHide[b]||(this.toHide[b]=!0,this.doImage(b))},show:function(a){this.toHide=this.toHide||{};var b;b="string"==typeof a?a:a.name,this.toHide[b]&&(this.toHide[b]=!1,this.doImage(b))},transform:function(a){this.setTransform(a,!0)},reset:function(){for(var a=0;a<this.images.length;a++)this.images[a].$panzoomEl.panzoom("reset"),0==a&&(this.lastTransform=this.images[a].$panzoomEl.panzoom("getMatrix"),this.module.controller.transformChanged(this.lastTransform))}},_getDefaultConf:function(){return{opacity:1,"z-index":1,rendering:"Normal",scaling:"max"}},_completeConf:function(a,b,c){if(!a)return this._completeConf(this._getDefaultConf(),b,c);"__highlight__"===b&&(c={"z-index":1e6,scaling:"asHighlight",rendering:"crisp-edges",opacity:.7}),a.variable=b;var d=f.assign(a,c);return d}}),h});
