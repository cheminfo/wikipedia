define(["modules/default/defaultview","src/util/util","src/util/datatraversing","src/util/context","lib/d3/d3.parcoords","src/util/api","lodash"],function(a,b,c,d,e,f,g){function h(){this._id=b.getNextUniqueId(),this._value=new DataArray,this._addedColumns={},this._currentColumns={},this._previousColumns=[]}return b.loadCss("lib/d3/d3.parcoords.css"),h.prototype=$.extend(!0,{},a,{init:function(){var a=this,b='<div class="parcoords" id="'+this._id+'"></div>';this.dom=$(b).css({height:"100%",width:"100%"}),d.listen(this.dom[0],[['<li><a><span class="ui-icon ui-icon-refresh"></span>Reset selection</a></li>',function(){a.resetBrush()}]]),this.jpathConfig=$.extend(!0,[],this.module.getConfiguration("colsjPaths")),this.preventHighlight=this.module.getConfigurationCheckbox("options","hide"),this.module.getDomContent().html(this.dom)},blank:{value:function(){this.dom.empty()},columns:function(){for(var a=0;a<this._previousColumns.length;a++)delete this._currentColumns[this._previousColumns[a].name];this._previousColumns=[]}},update:{value:function(a){a?(a=a.get(),this._value=a.length?a.resurrect():[]):this._value=[],this.redrawChart()},columns:function(a){if(Array.isArray(a)){for(var b=0;b<a.length;b++)this._currentColumns[a[b].name]=a[b];this._previousColumns=a,this.redrawChart()}}},onActionReceive:{addColumn:function(a){a&&a.name&&a.jpath&&(this._addedColumns[a.name]=a,this.redrawChart())},removeColumn:function(a){a&&a.name&&(delete this._addedColumns[a.name],this.redrawChart())}},inDom:function(){this.resolveReady()},onResize:function(){this.parcoords&&this.parcoords.width(this.width).height(this.height).resize().render()},redrawChart:function(){function a(a){b.module.controller.onBrushSelection(a)}var b=this;if(this.createIntermediateData(),this.dom.empty(),this._data&&this._data.length>0){var c=this.module.getConfiguration.bind(this.module),d=this.module.getConfigurationCheckbox.bind(this.module),f=this.parcoords=e.parcoords()("#"+this._id);f.data(this._data),f.detectDimensions(),this._names&&f.dimensions(this._names),this._color&&f.color(this._color),this._data.length>1e3&&(f.mode("queue"),f.rate(200)),f.render();var g=c("brushMode");f.brushMode(g),"None"!=g&&f.brushPredicate(c("brushPredicate")),d("options","reorder")&&f.reorderable(),d("options","shadow")&&f.shadows(),d("options","brush")||f.on("brush",a),f.on("brushend",a),this._parcoords=f}else this.dom.html("No column to display");this.module.controller.onBrushSelection(this._data)},createIntermediateData:function(){var a=this.getColumns(),c=a.length,d=this.module.getConfiguration("colorjpath"),e=this;d&&(d=b.makejPathFunction(d),this._color=function(a){return a.__color?a.__color:"#000"});var g=this._value,h=g.length;if(f.killHighlight(this.module.getId()),this._highlighted=[],!h)return void(this._data=[]);var i,j=new Array(h),k=new Array(c);for(i=0;c>i;i++)k[i]=a[i].name.toString();this._names=k;var l,m;for(i=0;h>i;i++){l={},m=g[i],j[i]=l,function(a){f.listenHighlight(m,function(b){b?e._highlighted.push(e._data[a]):e._highlighted.splice(e._highlighted.indexOf(e._data[a],1)),e.updateHighlight()},!1,e.module.getId())}(i);for(var n=0;c>n;n++){var o=a[n].jpathF(m);l[a[n].name]=o?o.valueOf():o}d&&(l.__color=d(m)),l.__id=i}this._data=j},getColumns:function(){var a,c=[],d={},e=this.jpathConfig;if(e)for(a=0;a<e.length;a++)e[a].jpath&&(d[e[a].name]=$.extend(!0,{},e[a]));$.extend(d,this._currentColumns,this._addedColumns);for(a in d)c.push(d[a]);for(a=0;a<c.length;a++)"function"!=typeof c[a].jpathF&&Object.defineProperty(c[a],"jpathF",{value:b.makejPathFunction(c[a].jpath)});return c},resetBrush:function(){this._parcoords&&(this._parcoords.brushReset(),this.module.controller.onBrushSelection(this._data))},updateHighlight:g.throttle(function(){var a=this._highlighted;if(this.preventHighlight){a=[];for(var b=this.parcoords.brushed(),c=0,d=this._highlighted.length;d>c;c++)b.indexOf(this._highlighted[c])>-1&&a.push(this._highlighted[c])}a.length?this.parcoords.highlight(a):this.parcoords.unhighlight()},20)}),h});