'use strict';define(["require","lodash","modules/default/defaultview","src/util/api","src/util/debug"],function(a,b,c,d,e){"use strict";function f(){}function g(a){if(a._highlighted&&a._highlighted.length){let b="selectionHalos on;";const c=a._highlighted.flat(),d=c.map(b=>a.module.data._atoms[b]).flat().map(a=>a+1);b+=`select atomno=[${d.join(",")}];`,a.executeScript(b)}else a.executeScript("selectionHalos off;")}function h(){this.lastHoveredAtom&&(d.highlightId(this.lastHoveredAtom.label,0),this.lastHoveredAtom=null)}var i={};window.addEventListener("message",function(a){try{var b=JSON.parse(a.data)}catch(a){return}if("jsmol"===b.module){var c=b.id;if(!i[c])return void e.error(`No view with ID ${c}`);var d,f=i[c];switch(b.type){case"ready":f.resolveReady();break;case"message":f.module.controller.onNewMessage(b.message);break;case"atomClick":d=f.parseAtom(b.message),f.module.controller.onAtomClick(d);break;case"atomHover":d=f.parseAtom(b.message),f._doHighlights(d),f.module.controller.onAtomHover(d);break;case"error":e.warn("An error message was received",b.message);break;case"execSync":f.module.controller.onSyncExecDone(b.message);break;default:e.error("Message type not handled: ",b.type);}}}),$.extend(!0,f.prototype,c,{init:function(){var b=this;this.actionOnloadScript="";var c=this.module.getId();i[c]=this;let d=(this.module.getConfiguration("prefs")||[]).includes("webgl");this.dom=$("<iframe>",{src:a.toUrl(`./jsmol.html?webgl=${d}`)}).css({border:0,height:"100%",width:"100%"}),this.module.getDomContent().html(this.dom).css({overflow:"hidden",height:"100%",width:"100%",display:"block"}),this._highlights=this._highlights||[],this.dom.bind("load",function(){b.postMessage("init",{id:c})})},onResize:function(){},inDom:function(){var a=this;this.dom.parent().on("mouseleave",function(){a.lastHoveredAtom&&(d.highlightId(a.lastHoveredAtom.label,0),a.lastHoveredAtom=null)})},blank:{data:function(){(this.module.data&&this.module.getConfiguration("prefs")||[]).includes("orientation")&&this.storeOrientation(),this.postMessage("blank","")}},update:{data:function(a){var b=this;this.module.data=a,b.postMessage("setMolFile",{_modelLoad:a.get(),_lattice:a._lattice,_script:a._script}),b.module.getConfiguration("script")&&b.postMessage("executeScript",[b.module.getConfiguration("script")]),b.actionOnloadScript&&b.postMessage("executeScript",[b.actionOnloadScript]),b.module.getConfiguration("syncScript")&&b.postMessage("executeScriptSync",[b.module.getConfiguration("syncScript")]),this._activateHighlights()}},onActionReceive:{jsmolscript:function(b){this.executeScript(b)},jsmolscriptSync:function(b){this.executeScriptSync(b)},setTempJsmolScript:function(a){this.actionOnloadScript=a}},executeScriptSync:function(a){this.postMessage("executeScriptSync",[a])},executeScript:function(a){this.postMessage("executeScript",[a])},postMessage:function(a,b){var c=this.dom.get(0).contentWindow;c&&c.postMessage(JSON.stringify({type:a,message:b}),"*")},remove:function(a){delete i[a]},parseAtom:function(a){var b=/^([^\s]+)\s+([^\s]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)\s+([-+]?[0-9]*\.?[0-9]+)/,c=b.exec(a);return{id:c[2],label:c[1],x:c[3],y:c[4],z:c[5]}},storeOrientation:function(){this.postMessage("saveOrientation",[])},_doHighlights:function(a){if(this.lastHoveredAtom){if(this.lastHoveredAtom.label===a.label)return void this._undoHighlightsDebounced();d.highlightId(this.lastHoveredAtom.label,0)}this._undoHighlights(),d.highlightId(a.label,1),this.lastHoveredAtom=a,this._undoHighlightsDebounced()},_undoHighlights:function(){h.call(this)},_undoHighlightsDebounced:function(){j.call(this)},_activateHighlights:function(){var a=this;if(this.module.data._highlight){if(!this.module.data._atoms)return void console.log("JSmol highlight module requires an object _atoms with list of atoms to hightlight");var c=b(this.module.data._highlight).flatten().uniq().value();a._highlighted=[],d.killHighlight(this.module.getId());for(var e=0;e<c.length;e++)(function(e){d.listenHighlight({_highlight:c[e]},function(c,d){Array.isArray(d)&&(d=[d]),a._highlighted=c?b(a._highlighted).push(d).flatten().uniq().value():[],k(a)},!1,a.module.getId())})(e)}}});var j=b.debounce(h,250);const k=b.debounce(a=>g(a),100);return f});
