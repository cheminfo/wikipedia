'use strict';define(["modules/default/defaultview","lib/twigjs/twig","src/util/debug","src/util/colorbar","src/util/color","components/papa-parse/papaparse.min","src/util/api","lodash","src/util/urldata"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(){}const k=293,l=["alkali","alkaline","transition","lanthanoid","actinoid","poor","metalloid","nonmetal","halogen","noble"];return $.extend(!0,j.prototype,a,{init(){this.dom=$("<div class=\"periodic-table\">"),this.elements=[],this.foreground=this._getOptions("foreground"),this.background=this._getOptions("background"),this.createTemplateFromPref("","pref"),this.createTemplateFromPref("hl","pref")},blank:{template(){this.template=b.twig({data:""}),this.dom.empty().unbind()},hltemplate(){this.hltemplate=b.twig({data:""}),this.dom.empty().unbind()},value(){this.dom.empty().unbind()}},inDom(){this.module.getDomContent().html(this.dom),this.getElements().then(()=>{this._activateHighlights(),this.resolveReady(),this.render()})},createTemplateFromPref(a){var c=`${a}templateSource`;if(c=this.module.getConfiguration(c),"pref"===c){var d=this.module.getConfiguration(`${a}template`);this[`${a}template`]=b.twig({data:d})}else this[`${a}template`]=b.twig({data:""})},createTemplateFromVar(a,c){var d=`${a}templateSource`;d=this.module.getConfiguration(d),"varin"===d&&(this[`${a}template`]=b.twig({data:c}))},update:{value(a){this.getElements(a).then(()=>{this._activateHighlights(),this.render()})},template(a){var b=a.get().toString();try{this.createTemplateFromVar("",b),this.render()}catch(a){c.info(`Problem with template: ${a}`)}},hltemplate(a){var b=a.get()+"";try{this.createTemplateFromVar("hl",b),this.render()}catch(a){c.info(`Problem with highlight template: ${a}`)}}},getElements(a){return Promise.resolve().then(()=>{var b=this.module.getConfiguration("elementsSource"),c=this.module.getConfiguration("elementsCode"),d=this.module.getConfiguration("elementsUrl");if("varin"===b&&a)this.setElements(a);else if("pref"===b)this.parseElements(c);else if("url"===b)return i.get(d,1800).then(a=>{this.parseElements(a)})})},setElements(a){var b=a.filter(a=>"atom"===a.label+"");if(this.module.getConfigurationCheckbox("useHighlights","yes"))for(var c=0;c<b.length;c++)b[c]._highlight=b[c].name;this.metadata=a.filter(a=>"atom"!==a.label+"");var d=this.module.getConfiguration("varName");d&&"varin"!==this.module.getConfiguration("elementsSource")&&g.createData(d,a),this.dataElements=DataObject.check(b,!0),this.elements=JSON.parse(JSON.stringify(DataObject.resurrect(b)))},parseElements(a){var b;if("string"==typeof a)try{if(b=JSON.parse(a),!Array.isArray(b))throw new Error}catch(d){try{b=f.parse(a,{delimiter:"\t",header:!0,dynamicTyping:!0}),b=b.data}catch(a){return void c.error("Could not parse elements")}}else b=a;this.setElements(b)},render(){function a(a){var c=a.data("idx"),d=b.elements[c];d&&(b.defaultLegend.addClass("hidden"),e.removeClass("hidden"),f.removeClass("hidden"),e.empty().unbind(),e.append(b.hltemplate.render({element:d})))}var b=this;b.dom.empty().unbind(),b.dom.append("<div class=\"indic-p indic-g\"></div>");for(let a=1;19>a;a++)b.dom.append(`<div class="indic-g group${a}"><p>${a}</p></div>`);for(let a=1;8>a;a++)b.dom.append(`<div class="indic-p period${a}"><p>${a}</p></div>`);for(let a=0;a<this.elements.length;a++){var c=$(`<div>${this.template.render({element:this.elements[a]})}</div>`).data("idx",a);c.addClass(`${"element e"}${this.elements[a].Z} period${this.elements[a].period} group${this.elements[a].group} block-${this.elements[a].block} ${this.elements[a].serie}`),b.dom.append(c)}var d=$("<div class=\"legend\"></div>");b.dom.find("div.e1").after(d),b.defaultLegend=$("<div class=\"default-legend\"></div>");var e=$("<div class=\"element-zoom hidden\"></div>"),f=$("<div class=\"element-datas hidden\"></div>");d.append(b.defaultLegend).append(e).append(f),b.innerLegend=$("<div class=\"inner-legend\"></div>"),b.defaultLegend.append(b.innerLegend),b.colorSerie=$(`<ul class="color-serie hidden">
                <li class="alkali">Alkali metals</li>
                <li class="alkaline">Alkalin earth metals</li>
                <li class="transition">Transition metals</li>
                <li class="lanthanoid">Lanthanoids</li>
                <li class="actinoid">Actinoids</li>
                <li class="poor">Post-transition metals</li>
                <li class="metalloid">Metalloids</li>
                <li class="nonmetal">Nonmetals</li>
                <li class="halogen">Halogens</li>
                <li class="noble">Noble gases</li>
                </ul>`),b.innerLegend.append(b.colorSerie);var i=b.$elements=b.dom.find(".element");b.innerLegend.append("<div class=\"stateOfMatter\"></div>"),b.stateOfMatter=b.innerLegend.find(".stateOfMatter"),"state"===b.foreground.mode&&(b.stateOfMatter.append(`<table><tbody>
                <tr><td class="solid">S</td><td>Solid</td><td class="liquid">L</td><td>Liquid</td></tr>
                <tr><td class="gas"">G</td><td>Gas</td><td class="unknown">U</td><td>Unknown</td></tr>
                </tbody></table>`),b.stateOfMatter.append("<dl class=\"periodic-value-list\"><dt>Pressure</dt><dd>101.325 kPa</dd></dl></div>")),"state"===b.foreground.mode?(b.defaultLegend.append(`<div class="periodicSlider" id="foregroundSlider"><input type="range" min="${0}" max="${6e3}" step="${1}" value="${k}"/></div>`),b.innerLegend.find("dl").append(`<dt>Temperature</dt><dd id="foregroundVal">${k} K</dd>`),this.updateElementPhase(k)):"custom"===b.foreground.mode?(b._addSlider("foreground"),b.updateColors("foreground",b.foreground.val)):"fixed"===b.foreground.mode&&i.css("color",b.foreground.fixedcolor),"custom"===b.background.mode?(b._addSlider("background"),b.updateColors("background",b.background.val)):"fixed"===b.background.mode&&i.css("background-color",b.background.fixedcolor);var j=!1;this.innerLegend.on("click","ul.color-serie li",a=>{b.unselectElements(a,i);var c=$(a.target).attr("class").split(" "),d=l.find(a=>c.some(b=>b===a));d&&(i.filter(`.${d}`).toggleClass("el-selected"),b.elementsSelected(),a.stopPropagation())}),b.defaultLegend.on("input","#foregroundSlider>input",a=>{"state"===b.foreground.mode?(this.updateElementPhase(a.target.value),b.innerLegend.find("#foregroundVal").html(`${a.target.value} K`)):(this.updateColors("foreground",a.target.value),b.innerLegend.find("#foregroundVal").html(`${a.target.value} ${this.foreground.unit}`))}),b.defaultLegend.on("input","#backgroundSlider>input",a=>{this.updateColors("background",a.target.value),b.innerLegend.find("#backgroundVal").html(`${a.target.value} ${this.background.unit}`)});var m=h.debounce(()=>{$(".element-zoom").delay(5e4).empty().unbind(),b.defaultLegend.removeClass("hidden"),this.module.getConfigurationCheckbox("display","families")&&b.colorSerie.removeClass("hidden"),e.addClass("hidden"),f.addClass("hidden")},150);m(),i.mouseenter(function(){var c=$(this),d=b.getZ(c);b._doHighlight(d,!0),b.module.controller.elementHovered(d),j||(m.cancel(),a(c))}),i.mouseleave(function(){var a=$(this),c=b.getZ(a);b._doHighlight(c,!1),j||m()}),i.click(function(c){b.unselectElements(c,i);var d=$(this);d.toggleClass("el-selected"),b.elementSelected(d),a(d),b.elementsSelected(),j=!0,c.stopPropagation()}),i.dblclick(function(){var a=$(this);a.removeClass("el-selected"),j=!1}),b.dom.on("click",".indic-p",function(a){var c=$(this).attr("class").replace(/^.*(period\d+).*$/,"$1"),d=c.substr(6);b.unselectElements(a,i);var e=i.filter(`.${c}`);e.toggleClass("el-selected"),b.module.controller.periodSelected(d),b.elementsSelected(),a.stopPropagation()}),b.module.getDomContent().on("click",function(){j=!1,m(),i.removeClass("el-selected"),b.module.controller.elementsSelected(b.elements.map(a=>a.Z))}),b.dom.on("click",".indic-g",function(a){var c=$(this).attr("class").replace(/^.*(group\d+).*$/,"$1"),d=c.substr(5);b.unselectElements(a,i);var e=i.filter(`.${c}`);e.toggleClass("el-selected"),b.module.controller.groupSelected(d),b.elementsSelected(),a.stopPropagation()});d.after("<div class=\"interactive-zone\"><div id=\"slider\"></div>");b.dom.find("div.e56").after("<div class=\"indic-f period6\"><p>57-71</p></div>"),b.dom.find("div.e88").after("<div class=\"indic-f period7\"><p>89-103</p></div>"),b.module.controller.elementsSelected(b.elements.map(a=>a.Z))},_getOptions(a){var b=this.module.getConfiguration,c={};return["Min","Max","Val","MinColor","MaxColor","NeutralColor","NoValueColor","FixedColor","Step","Label","Unit","Mode","Jpath"].forEach(d=>{var f=d.toLowerCase();c[f]=b(`${a}${d}`),d.match(/color/i)&&(c[f]=e.array2rgba(c[f]))}),[["ShowSlider","yes"]].forEach(b=>{c[b[0].toLowerCase()]=this.module.getConfigurationCheckbox(`${a}${b[0]}`,b[1])}),c},_getGradientFunction(a,b){var c=this.defaultLegend.width(),e={stops:[this[a].mincolor,this[a].neutralcolor,this[a].maxcolor],stopPositions:[this[a].min,b,this[a].max],domain:[this[a].min,this[a].max],stopType:"values",width:c,height:51,returnMode:"svg",axis:{orientation:"top"}};e.axis.tickValues=e.stopPositions;var f=this.defaultLegend.find(`#${a}Slider .periodicGradient`);return f.empty(),f[0]&&d.renderSvg(f[0],e),d.getColorScale(e)},_addSlider(a){this[a].showslider&&this.defaultLegend.append(`<div class="periodicSlider" id="${a}Slider"><input type="range" min="${this[a].min}" max="${this[a].max}" step="${this[a].step}" value="${this[a].val}"/><div class="periodicGradient"></div></div>`),this.innerLegend.find("dl").append(`<dt>${this[a].label}</dt><dd id="${a}Val">${this[a].val} ${this[a].unit}</dd>`)},unselectElements(a,b){a.ctrlKey||a.metaKey||b.removeClass("el-selected")},elementSelected(a){this.module.controller.elementSelected(this.getZ(a))},elementsSelected(){var a=this.dom.find(".el-selected").map((a,b)=>this.getZ($(b))).toArray();this.module.controller.elementsSelected(a)},onActionReceive:{select(a){var b=this.dom.find(".element").toArray();this._selectElements(b,a)},setSelected(a){var b=this.dom.find(".element");this.unselectElements({},b),this._selectElements(b.toArray(),a)}},_selectElements(a,b){if(Array.isArray(b)){const e=a=>a.Z===b[d];for(var c,d=0;d<b.length;d++)c=this.elements.findIndex(e),0<=c&&$(a[c]).addClass("el-selected")}else if("function"==typeof b)for(var e=0;e<this.elements.length;e++)b(this.elements[e])&&$(a[e]).addClass("el-selected");this.elementsSelected()},getZ(a){return a.attr("class").replace(/^.*[^a-zA-Z]e(\d+).*$/,"$1")},updateColors(a,b){var d=this._getGradientFunction(a,b),f=this.dom.find(".element");for(let c,k=0;k<f.length;k++){c=$(f[k]);var g=c.data("idx"),h=+this.dataElements.getChildSync([g].concat(this[a].jpath));if(isNaN(h))var j={rgba:this[a].novaluecolor};else j=d(h),j.rgba=e.array2rgba(e.hex2rgb(j.color).concat(j.opacity));"foreground"===a?c.css({color:j.rgba}):c.css({backgroundColor:j.rgba})}},updateElementPhase(a){var b=this.dom.find(".element");for(let d,e=0;e<b.length;e++){d=$(b[e]);var c=d.data("idx");if(void 0!==c){let b=this.elements[c],e=+b.boiling,f=+b.melting;isNaN(e)&&isNaN(f)?(d.removeClass("solid liquid gas"),d.addClass("unknown")):a<f?(d.removeClass("liquid gas unknown"),d.addClass("solid")):a<e?(d.removeClass("solid gas unknown"),d.addClass("liquid")):(d.removeClass("liquid solid unknown"),d.addClass("gas"))}}},_activateHighlights:function(){var a=this,b=h(a.elements).map("_highlight").flatten().filter(a=>!h.isUndefined(a)).value();a._highlighted=[],g.killHighlight(a.module.getId());for(let c=0;c<b.length;c++)g.listenHighlight({_highlight:b[c]},function(b,c,d,e){e===a.module.getId()||(!Array.isArray(c)&&(c=[c]),a._highlighted=b?h(a._highlighted).push(c).flatten().uniq().value():h.filter(a._highlighted,function(a){return-1===c.indexOf(a)}),a._drawHighlight())},!1,a.module.getId())},_doHighlight(a,b){if(this.elements){var c=this.elements.find(b=>b.Z==a);c&&g.highlightId(c.name,b,this.module.getId())}},_drawHighlight(){if(this.elements&&this.$elements){var a=this.elements.filter(a=>-1<this._highlighted.indexOf(a._highlight));this._unhighlightElements(),a.forEach(a=>{this._highlightElement(a.Z)})}},_unhighlightElements(){this.$elements.css({border:"",transform:"scale(1)",zIndex:0})},_highlightElement(a){var b=this.$elements.filter(`.e${a}`);b.css({border:"solid 2px red",transform:"scale(1.1)",zIndex:1})}}),j});
