define(["modules/default/defaultview","lib/plot/plot","src/util/datatraversing","src/util/urldata"],function(a,b,c,d){function e(){}return e.prototype=$.extend(!0,{},a,{init:function(){var a=[];a.push('<div class="ivstab"><div class="iv"><h2>IV Curve</h2><div class="ivcurve"></div><h2>Legend</h2><div class="ivstablegend"></div></div><div class="stab"><div><h2>Voc</h2><div class="ivstability-voc"></div><h2>Jsc</h2><div class="ivstability-jsc"></div><h2>Fill Factor</h2><div class="ivstability-ff"></div><h2>Efficiency</h2><div class="ivstability-efficiency"></div></div></div></div>'),this.namedSeries={},this.graphs=[],this.series={},this.ivseries={},this.colors=["#0066cc","#cc0033","#cc00cc","#00cccc","#009933","#999966","#cc9900","#669999","#000000"],this.usedColors=[],this.legends=[],this.dom=$(a.join("")),this.legendDom=this.dom.find(".ivstablegend"),this.module.getDomContent().html(this.dom).css("overflow","hidden"),this.resolveReady()},doIv:function(a,b,c,d,e){this.ivseries[b]||(this.ivseries[b]={}),this.ivseries[b][a]||(this.ivseries[b][a]=this.iv.newSerie(b),this.ivseries[b][a].autoAxis()),this.ivseries[b][a].setData(c.data),this.ivseries[b][a].setLineColor(d),this.ivseries[b][a].setLineStyle(e),this.iv.redraw(),this.iv.drawSeries()},inDom:function(){var a=this,c={paddingTop:5,paddingBottom:0,paddingLeft:20,paddingRight:20,close:{left:!0,right:!0,top:!0,bottom:!0},title:"",zoomMode:"xy",defaultMouseAction:"zoom",defaultWheelAction:"none",lineToZero:!1,fontSize:12,fontFamily:"Myriad Pro, Helvetica, Arial",onMouseMoveData:function(){},onVerticalTracking:function(b,c,e){for(var f in a.series)d.get("http://lpidb.epfl.ch/content/ajax/getstabilityiv.ajax.php?id="+f+"&date="+c).done(function(c){for(var d in c)a.doIv(b,d,c[d],a.graphs[0].getSerie(d).getLineColor(),e)})}},e={bottom:[{labelValue:"Time (h)",unitModification:"time",shiftToZero:!0,primaryGrid:!1,nbTicksPrimary:10,secondaryGrid:!1,axisDataSpacing:{min:0,max:.1}}],left:[{labelValue:"",ticklabelratio:1,primaryGrid:!0,secondaryGrid:!1,nbTicksPrimary:3,forcedMin:0}]};this.graphs.push(new b(this.dom.find(".ivstability-jsc").get(0),c,$.extend(!0,{},e,{left:[{labelValue:"Jsc (mA/cm2)"}]}))),this.graphs.push(new b(this.dom.find(".ivstability-voc").get(0),c,$.extend(!0,{},e,{left:[{labelValue:"Voc (mV)"}]}))),this.graphs.push(new b(this.dom.find(".ivstability-ff").get(0),c,$.extend(!0,{},e,{left:[{labelValue:"FF (-)"}]}))),this.graphs.push(new b(this.dom.find(".ivstability-efficiency").get(0),c,$.extend(!0,{},e,{left:[{labelValue:"Efficiency (%)"}]}))),this.iv=new b(this.dom.find(".ivcurve").get(0),c,{bottom:[{labelValue:"Voc (mv)",unitModification:!1,shiftToZero:!1,primaryGrid:!1,secondaryGrid:!1,axisDataSpacing:{min:0,max:.1}}],left:[{labelValue:"Jsc (mA)",ticklabelratio:1,primaryGrid:!0,secondaryGrid:!1,forcedMin:0}]})},onResize:function(){for(var a=0;4>a;a++)this.graphs[a].resize(650,175),this.graphs[a].drawSeries();this.iv.resize(500,200),this.iv.drawSeries()},update:{plotdata:function(){},serieSet:function(){}},getNextColor:function(){return this.colors.shift()},editCellComment:function(a,b){$.get("http://lpidb.epfl.ch/content/ajax/setcellcomment.ajax.php",{cellid:a,comment:b})},addLegend:function(a,b,c,d){var e=$("<div />");this.legends[a]=e;var f=this,g="(Insert a comment here)";square=$("<div />").css({width:30,height:30,backgroundColor:d,"float":"left",position:"relative",marginTop:"0px",marginBottom:"10px"}),nameDom=$("<div />").css({marginLeft:"35px",fontSize:"1.1em"}).text(b),descriptionDom=$("<div />").css({marginLeft:"35px",marginTop:"2px"}).attr("contentEditable","true").text(c||g).bind("mousedown",function(){$(this).text()==g&&$(this).text("").css({color:"black",fontStyle:"normal"}).focus()}).bind("keypress",function(a){return 13==a.keyCode?(a.preventDefault(),$(this).trigger("blur"),!1):void 0}).bind("blur",function(){var b=$(this).text();""==b||null==b||b==g?$(this).text(g).css({color:"grey",fontStyle:"italic"}):f.editCellComment(a,b)}).bind("change",function(){}).trigger("blur"),clearDom=$("<div />").css({clear:"both"}),e.append(square).append(nameDom).append(descriptionDom).append(clearDom),this.legendDom.append(e)},removeLegend:function(a){this.legends[a]&&(this.legends[a].remove(),delete this.legends[a])},onActionReceive:{addSerie:function(a){a=c.getValueIfNeeded(a);var b={trackMouse:!0};this.onActionReceive.removeSerieByName.call(this,a.id);var d=this.getNextColor();this.series[a.id]=[];var e=this.graphs[0].newSerie(a.id,b);e.setLineColor(d),e.autoAxis(),e.setData(a.curves.jsc),this.series[a.id].push(e);var e=this.graphs[1].newSerie(a.id,b);e.setLineColor(d),e.autoAxis(),e.setData(a.curves.voc),this.series[a.id].push(e);var e=this.graphs[2].newSerie(a.id,b);e.setLineColor(d),e.autoAxis(),e.setData(a.curves.ff),this.series[a.id].push(e);var e=this.graphs[3].newSerie(a.id,b);e.setLineColor(d),e.autoAxis(),e.setData(a.curves.eff),this.series[a.id].push(e);for(var f=0;4>f;f++)this.graphs[f].redraw(),this.graphs[f].drawSeries();this.addLegend(a.id,a.name,a.description,d)},removeSerie:function(a){var b=c.getValueIfNeeded(a);this.removeLegend(b.id),this.onActionReceive.removeSerieByName.call(this,b.name)},removeSerieByName:function(a){if(this.series[a]){this.colors.unshift(this.series[a][0].getLineColor());for(var b=0;4>b;b++)this.series[a][b].kill();delete this.series[a]}if(this.ivseries[a]){for(var b in this.ivseries[a])this.ivseries[a][b].kill();delete this.ivseries[a]}}},getDom:function(){return this.dom}}),e});