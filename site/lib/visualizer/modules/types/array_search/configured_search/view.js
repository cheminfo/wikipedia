define(["modules/default/defaultview","src/util/datatraversing","src/util/api","lib/formcreator/formcreator","src/util/util"],function(Default,Traversing,API,FormCreator,Util){function View(){}return View.prototype=$.extend(!0,{},Default,{init:function(){var a=this,b=$("<div>").css({position:"relative",height:"100%",weight:"100%"});this.overlay=$("<div>").css({position:"absolute",height:"100%",width:"100%",zIndex:1e3,backgroundColor:"rgba(200,200,200,0)",color:"rgba(50,50,50,0)",display:"none"}).appendTo(b).click(function(b){b.stopPropagation(),a.searchEnabled=!0,a.overlay.animate({backgroundColor:"rgba(200,200,200,0)",color:"rgba(50,50,50,0)"},500,function(){a.overlay.css("display","none")}),a.search()}).append($("<div>"+this.module.getConfiguration("disableMessage")+"</div>").css({textAlign:"center",width:"100%",zIndex:1001,display:"table-cell",verticalAlign:"middle",fontSize:"20pt"})),this.searchEnabled=!0,this.dom=$("<div>").appendTo(b),this.module.getDomContent().html(b),this.variables={},this.cfgValue={},this.maxhits=parseInt(this.module.getConfiguration("maxhits"))||Number.POSITIVE_INFINITY,this._jpathsFcts={};for(var c=this.module.getConfiguration("searchfields"),d=this.module.definition.vars_out||[],e=[],f=0,g=d.length,h={sections:{cfg:{groups:{cfg:{options:{type:"list"},fields:FormCreator.makeStructure(c,function(b){var c=0;for(b.groups.general[0].searchOnField.length;b.groups.general[0].searchOnField[c];c++)Util.addjPathFunction(a._jpathsFcts,b.groups.general[0].searchOnField[c])})}}}}};g>f;f++)e.push(d[f].name);var i=FormCreator.makeForm();i.init({onValueChanged:function(){var b=i.getValue().sections.cfg[0].groups.cfg[0],c={};for(var d in b)c[d]=b[d][0];$.extend(a.cfgValue,c),a.search()}}),i.setStructure(h),i.onStructureLoaded().done(function(){i.fill({})}),i.onLoaded().done(function(){a.dom.html(i.makeDom(2)),i.inDom(),i.fieldElementValueChanged()}),this.makeSearchFilter(),this.resolveReady()},blank:{value:function(){this.dom.empty()}},search:function(){if(this.searchEnabled){var a,b,c,d=this.cfgValue,e=new DataArray,f=new DataArray,g=Object.keys(this.variables);if(0===g.length||0===Object.keys(d).length)return;var h=this.maxhits,i=0;for(var j in g)for(c=this.variables[g[j]],b=c.length,a=0;b>a;a++)this.searchElement(d,c.getChildSync([a]).get())?(h>i&&(e[i++]=c[a]),f[a]=!0):f[a]=!1;this.module.controller.searchDone(e,f)}},_makeOp:function(a,b,c){b='cfg[ "'+b+'" ]';var d="",e="";c.number&&(d="parseFloat(",e=")");var f=".toLowerCase()";switch(c.caseSensitive&&(f=""),a){case"=":case"eq":return c.number?" el == "+d+b+e+" ":' ((el+"")'+f+") == "+b+f+" ";case"<>":case"><":case"!=":return' (el + "") !== '+b+" ";case">":return" el > "+d+b+e+" ";case">=":return" el >= "+d+b+e+" ";case"<":return" el < "+d+b+e+" ";case"<=":return" el <= "+d+b+e+" ";case"contains":return" el"+f+".match("+b+f+") ";case"notcontain":return" ! el"+f+".match("+b+f+") ";case"starts":return" el"+f+'.match(new RegExp("^"+'+b+f+")) ";case"end":return" el"+f+".match(new RegExp("+b+f+'+"$")) ';case"btw":return" ( el >= parseFloat( "+b+"[0] ) && el <= parseFloat( "+b+"[1] ) )"}},makeSearchFilter:function(){var self=this,searchfields=this.module.getConfiguration("searchfields"),i=0,l=searchfields.length,searchOn,toEval="";for(toEval+=" this._searchFunc = function( cfg, row ) { ",toEval+=" var el; ",toEval+=" return ";l>i;i++){searchOn=searchfields[i].groups.general[0].searchOnField||[],i>0&&(toEval+=" && ");var j=0,k=searchOn.length;if(k>0){for(toEval+=" ( ";k>j;j++){j>0&&(toEval+=" || ");var opts={};"float"===searchfields[i].groups.general[0].type[0]&&(opts.number=!0),searchfields[i].groups.text&&"case_sensitive"===searchfields[i].groups.text[0].case_sensitive[0][0]&&(opts.caseSensitive=!0);var allow_undefined=!1;searchfields[i].groups.general[0].allow_undefined&&searchfields[i].groups.general[0].allow_undefined[0]&&(allow_undefined=!!searchfields[i].groups.general[0].allow_undefined[0].length),toEval+=' ( ( el = self.getJpath( "'+searchOn[j]+'", row ) ) ? ( ',toEval+=this._makeOp(searchfields[i].groups.general[0].operator[0],searchfields[i].groups.general[0].name[0],opts),toEval+=" ) : "+allow_undefined+" ) "}toEval+=" ) "}}toEval+=";};";try{this._searchFunc=null,eval(toEval)}catch(a){console.error("Error while evaluating function."),console.log(toEval)}},searchElement:function(a,b){return this._searchFunc(a,b)},getJpath:function(a,b){return this._jpathsFcts[a](b)},update:{array:function(a,b){a&&(this.variables[b]=a.get(),this.search())}},typeToScreen:{},onActionReceive:{disable:function(){this.searchEnabled&&(this.searchEnabled=!1,this.overlay.css("display","table"),this.overlay.animate({backgroundColor:"rgba(200,200,200,0.6)",color:"rgba(50,50,50,1)"},500))}}}),View});