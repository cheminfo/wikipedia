'use strict';define(["jquery","modules/types/client_interaction/code_editor/controller","src/util/api","src/util/debug","src/util/sandbox","src/util/util"],function(a,b,c,d,e,f){"use strict";function g(){b.call(this),this.currentScript=null,this.outputObject={},this.reloaded=!0,this.scriptID=0,this.executing=0}function h(a,b){let c=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};this.controller=a,this.title=a.module.definition.title+"",this.libs=b;var d=i(this),f=this.controller.module.view._code;this._sandbox=new e,this._sandbox.setContext(d);try{this.theFunction=this._sandbox.run(`(${c.topAwait?"async ":""}function(${a.neededAliases}) {${f}\n})`,`CodeExecutor${this.controller.module.getId()}`)}catch(a){j(this.title,a)}this.wasSet=!1}function i(a){var b=function(b,c){a.wasSet=!0,a.doVariable(b,c)},d=function(){a.wasSet=!0,a.controller.outputObject={}},e=function(b){a.wasSet=!0,delete a.controller.outputObject[b]},f=function(b){a.done(b)},g=function(){a.async()},h=function(a,b){c.doAction(a,b)},i=function(b){a.controller.showButton(b)},j=function(b){a.controller.hideButton(b)},k={variables:{},variable:null,event:null,button:null,action:null,defined:0,set:b,get:function(a){var b=this.variables[a];if(b)return b.get()},sendAction:h,setAsync:g,done:f,clear:d,unset:e,showButton:i,hideButton:j,enableButton:function(b){a.controller.enableButton(b)},disableButton:function(b){a.controller.disableButton(b)},getButton:function(b){return a.controller._getButton(b)},moduleTriggerChange:a.controller.module.model.dataTriggerChange.bind(a.controller.module.model)},l={getVariable(){return k.variable},getVariables(){return k.variables},getEvent(){return k.event},getButton(){return k.button},getAction(){return k.action},getDefined(){return k.defined},set:b,get:function(a){return k.get(a)},sendAction:h,setAsync:g,done:f,clear:d,unset:e,showButton:i,hideButton:j};return a.context=k,l}function j(a,b){var c="";b&&b.stack&&(c=b.message,b=b.stack);var f="Code executor error";a&&(f+=` (${a})`),c&&(f+=`: ${c}`),d.error(f),d.warn(b)}return f.inherits(g,b),g.prototype.moduleInformation={name:"Code executor",description:"Write code that can be executed on input variable, action or just the push of a button",author:"Micha\xEBl Zasso",date:"12.01.2015",license:"MIT"},g.prototype.references={inputValue:{label:"Input value"},outputValue:{label:"Output value"}},g.prototype.events={onScriptEnded:{label:"Code execution ended",refVariable:["outputValue"]}},g.prototype.variablesIn=["inputValue"],g.prototype.actionsIn=a.extend({},g.prototype.actionsIn,{execute:"Execute the code"}),g.prototype.configurationStructure=function(){return{groups:{group:{options:{type:"list"},fields:{display:{type:"checkbox",title:"Display",options:{editor:"Code editor",buttons:"Buttons"},default:["editor","buttons"]},execOnLoad:{type:"checkbox",title:"Execute on load",options:{yes:"Yes"},default:[]},asyncAwait:{type:"checkbox",title:"Async/Await support",options:{top:"Top-level await"},default:["top"]},script:{type:"jscode",title:"Code",default:""}}},libs:{options:{type:"table",multiple:!0,title:"Required libraries"},fields:{lib:{type:"text",title:"url"},alias:{type:"text",title:"alias"}}},buttons:{options:{type:"table",multiple:!0,title:"Buttons"},fields:{name:{type:"text",title:"Name",default:"button1"},label:{type:"text",title:"Label",default:"Execute"},hide:{type:"checkbox",title:"Hide on load",options:{hide:"Yes"},default:[]},disable:{type:"checkbox",title:"Disable on load",options:{disable:"Yes"},default:[]}}}}}},g.prototype.configAliases={script:["groups","group",0,"script",0],execOnLoad:["groups","group",0,"execOnLoad",0],asyncAwait:["groups","group",0,"asyncAwait",0],display:["groups","group",0,"display",0],libs:["groups","libs",0],buttons:["groups","buttons",0]},g.prototype.onButtonClick=function(a){return 0<this.executing?d.warn("Already executing..."):void this.initExecutor().then(function(b){b.setButton(a),b.execute()})},g.prototype.onLoadScript=function(){this.initExecutor().then(function(a){a.setLoadScript(),a.execute()})},g.prototype.onVariableIn=function(a){this.initExecutor().then(function(b){b.setVariable(a),b.execute()})},g.prototype.onActionIn=function(a,b){this.initExecutor().then(function(c){c.setAction(a,b),c.execute()})},g.prototype.initImpl=function(){this.stopExecution();var a=this.module.getConfiguration("libs"),b=[],c=[];if(a)for(var d,e=0;e<a.length;e++)d=a[e],d.lib&&(b.push(d.lib),c.push(d.alias||`required_anonymous_${e}`));b.unshift("src/util/api"),c.unshift("API"),this.neededUrls=b,this.neededAliases=c.join(", "),this.resolveReady(),this.reloaded=!0,this.module.getConfigurationCheckbox("execOnLoad","yes")&&this.onLoadScript()},g.prototype.initExecutor=function(){var a,b=this,c=this.module.view._code;if(!this.reloaded&&this.currentScript==c)a=Promise.resolve(this._executor||this._loadingExecutor);else{this.reloaded=!1;var d=new Promise(a=>{require(this.neededUrls,function(){for(var d=Array(b.neededUrls.length),e=0;e<b.neededUrls.length;e++)d[e]=0>e||arguments.length<=e?void 0:arguments[e];var f=new h(b,d,{topAwait:b.module.getConfigurationCheckbox("asyncAwait","top")});b.currentScript=c,b._executor=f,b._loadingExecutor=null,a(f)})});this._loadingExecutor=d,a=d}return a.then(a=>(a.init(),a))},g.prototype.onGlobalPreferenceChange=function(){this.reloaded=!0},g.prototype.startExecution=function(){this.executing++,this.module.view.disableButtons()},g.prototype.stopExecution=function(){0<this.executing&&this.executing--,0===this.executing&&this.module.view.enableButtons()},g.prototype.showButton=function(a){this._changeButton(a,"show")},g.prototype.hideButton=function(a){this._changeButton(a,"hide")},g.prototype.disableButton=function(a){this._changeButtonProperty(a,"disabledFromScript",!0),this._changeButton(a,"disable")},g.prototype.enableButton=function(a){this._changeButtonProperty(a,"disabledFromScript",!1),this._changeButton(a,"enable")},g.prototype._changeButtonProperty=function(a,b,c){if(this.module.view.buttons){var e=this.module.view.buttons.find(c=>c.name===a);e?e[b]=c:d.error(`button ${a} not found`)}},g.prototype._getButton=function(a){return this.module.view.buttons.find(c=>c.name===a)},g.prototype._changeButton=function(a,b){if(this.module.view.buttons){var c=this.module.view.buttons.find(c=>c.name===a);c?c[b]():d.error(`button ${a} not found`)}},h.prototype.init=function(){this.context.event=null,this.context.button=null,this.context.action=null,this.context.variable=null,this.context.variables={},this.context.defined=0},h.prototype.setButton=function(a){this.context.event="button",this.context.button=a},h.prototype.setLoadScript=function(){this.context.event="load"},h.prototype.setVariable=function(a){this.context.variable=a,this.context.event="variable"},h.prototype.setAction=function(a,b){this.context.event="action",this.context.action={name:a,value:b}},h.prototype.doVariable=function(a,b){this.controller.outputObject[a]=b},h.prototype.execute=function(){this.controller.startExecution();var a=this.controller.module.view._input,b={},c=0;for(var d in a)null!=a[d]&&(c++,b[d]=a[d]);this.context.variables=b,this.context.defined=c,this.wasSet=!1,this._async=!1,this._done=Promise.resolve();try{var e=Promise.resolve(this.theFunction.apply(this.context,this.libs));this._async||(this._done=e)}catch(a){j(this.title,a)}this.setOutput()},h.prototype.setOutput=function(){var a=this;this._done.then(function(){return a.wasSet&&a.controller.createDataFromEvent("onScriptEnded","outputValue",a.controller.outputObject),null},function(b){j(a.title,b)}).then(function(){a.controller.stopExecution()})},h.prototype.async=function(){if(!this._async){this._async=!0;var a=this;this._done=new Promise(function(b,c){a.done=function(a){"Error"===f.objectToString(a)?c(a):b()}})}},h.prototype.done=function(){},g});
