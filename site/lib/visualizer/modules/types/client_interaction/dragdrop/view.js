define(["modules/default/defaultview","bowser"],function(a,b){function c(){}function d(a){return new Promise(function(b){function c(a){if(g=a,navigator.mozGetUserMedia)i.mozSrcObject=g;else{var b=window.URL||window.webkitURL;i.src=b.createObjectURL(g)}i.play()}function d(){j.width=l,j.height=m,j.getContext("2d").drawImage(i,0,0,l,m),e=j.toDataURL("image/png")}h||(h=$("<div/>"),$("body").append(h));var e=null;h.html(a);var f=!1,i=document.querySelector("#video"),j=document.querySelector("#canvas"),k=document.querySelector("#startbutton"),l=320,m=0;navigator.getMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia,navigator.getMedia({video:!0,audio:!1},c,function(a){console.error("An error occured! "+a)}),i.addEventListener("canplay",function(){f||(m=i.videoHeight/(i.videoWidth/l),i.setAttribute("width",l),i.setAttribute("height",m),j.setAttribute("width",l),j.setAttribute("height",m),f=!0)},!1),k.addEventListener("click",function(a){d(),a.preventDefault()},!1),h.dialog({modal:!0,buttons:{Cancel:function(){$(this).dialog("close")},Ok:function(){b(e),$(this).dialog("close")}},close:function(){return g?(g.stop(),b(e)):b(!1)},width:400})})}b.mobileos=b.ios||b.android||b.blackberry||b.firefoxos||b.webos||!1;var e=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),f=!b.mobileos&&e;c.prototype=$.extend(!0,{},a,{init:function(){var a=this,b=$("<input/>").css("display","none").attr({type:"file"}),c=this.module.getConfiguration("capture");if(c&&"none"!==c)switch(b.attr("capture",c),c){case"camera":b.attr("accept","image/*");break;case"camcorder":b.attr("accept","video/*");break;case"microphone":b.attr("accept","audio/*")}var e=$("<textarea>").css({position:"absolute",top:0,left:0,height:0,width:0,opacity:0}).on("paste",function(b){b.preventDefault(),b.stopPropagation(),a.module.controller.open(b.originalEvent.clipboardData)}),g=this.module.getConfiguration("label");this.messages={"default":g,drag:this.module.getConfiguration("dragoverlabel")||g,hover:this.module.getConfiguration("hoverlabel")||g},this.messageP=$("<div>").css("display","inline-block").html(this.messages["default"]),this.dom=$("<div />",{"class":"dragdropzone"}).html(this.messageP).on("click mousemove",function(){e.focus()}).mouseout(function(){e.blur()}).append(e),this.dom.on("click",function(c){c.stopPropagation(),f&&a.module.getConfigurationCheckbox("getusermedia","yes")?d($('<video id="video"></video><button id="startbutton">Take photo</button><canvas id="canvas"></canvas>')).then(function(b){b&&b&&a.module.controller.openPhoto(b)}):b.click()}),b.on("change",function(b){a.module.controller.open(a.module.controller.emulDataTransfer(b))}),b.on("load",function(){}),this.module.getDomContent().html(this.dom)},inDom:function(){var a=this,b=this.dom.get(0),c=0;b.addEventListener("mouseenter",function(b){b.stopPropagation(),b.preventDefault(),a.messageP.html(a.messages.hover),a.dom.addClass("dragdrop-over")}),b.addEventListener("dragenter",function(b){c++,b.stopPropagation(),b.preventDefault(),1===c&&(a.messageP.html(a.messages.drag),a.dom.addClass("dragdrop-over"))}),b.addEventListener("dragover",function(a){a.stopPropagation(),a.preventDefault()}),b.addEventListener("dragleave",function(b){c--,b.stopPropagation(),b.preventDefault(),c||(a.messageP.html(a.messages["default"]),a.dom.removeClass("dragdrop-over"))}),b.addEventListener("mouseleave",function(b){b.stopPropagation(),b.preventDefault(),a.messageP.html(a.messages["default"]),a.dom.removeClass("dragdrop-over")}),b.addEventListener("drop",function(b){c=0,b.stopPropagation(),b.preventDefault(),a.module.controller.open(b.dataTransfer)}),this.resolveReady()},onResize:function(){var a=this.dom.first("div"),b=this.dom.parent().parent();a.css("font-size",26);var c=26;if(c)for(;b.height()-40<a.height()&&c>2;)a.css("font-size",--c)}});var g,h;return c});