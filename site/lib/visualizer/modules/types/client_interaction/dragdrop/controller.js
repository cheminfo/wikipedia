'use strict';define(["jquery","modules/default/defaultcontroller","src/util/api","src/util/versioning","src/data/structures","src/util/debug","src/util/util","src/util/ui","src/util/mimeTypes"],function(a,b,c,d,e,f,g,h,i){"use strict";function j(){this.flushData=this.flushData.bind(this)}function k(a){var b=[];for(let c,d=0;d<a.length;d++)c=a[d],b.push({kind:c.kind,type:"text/plain"===c.type?"auto":c.type,str:new Promise(function(a){c.getAsString(a)}),id:d});return b}function l(a){return function(b){return i.lookup(b)||a}}function m(a){var b="";for(let c=0;c<a.length;c++){var e=a[c];b+="mime"===e.filter?"Mime: ":"Extension: ",b+=`${e.extension}<br>`}return b+="<br><br>",b}return a.extend(!0,j.prototype,b),j.prototype.moduleInformation={name:"Drag and drop",description:"Drop a file or paste some content to load",author:"Norman Pellet, Micha\xEBl Zasso",date:"31.07.2014",license:"MIT",cssClass:"dragdrop"},j.prototype.references={data:{label:"First data element"},dataarray:{label:"Array of loaded data"}},j.prototype.events={onRead:{label:"The data has been read",refVariable:["data","dataarray"],refAction:["data","dataarray"]}},j.prototype.configurationStructure=function(){const a=g.getStructuresComboOptions();return{groups:{group:{options:{type:"list"},fields:{label:{type:"text",title:"Text displayed by default",default:"Drop your file here"},dragoverlabel:{type:"text",title:"Text displayed on drag"},hoverlabel:{type:"text",title:"Text displayed on hover drop / paste area",default:"Drag'n drop or paste here"},fileSelectLabel:{type:"text",title:"Text displayed on file select button",default:"Select file"},labelFontSize:{type:"float",title:"Size of the label text",default:26},checkOptions:{type:"checkbox",title:"General options",options:{promptAmbiguous:"Prompt for filename when ambiguous"},default:["promptAmbiguous"]},inputOptions:{type:"checkbox",title:"Input options",options:{allowDrop:"Allow files to be dropped",allowPaste:"Allow text to be pasted",allowCamera:"Allow taking pictures with camera",allowFileInput:"Allow open file dialog",showFileInputButton:"Show file input button"},default:["allowDrop","allowPaste","allowFileInput"]}}},vars:{options:{type:"table",multiple:!0,title:"For files"},fields:{filter:{type:"combo",title:"filter on",options:[{title:"File extension",key:"ext"},{title:"Mime-type",key:"mime"}],default:"ext"},extension:{type:"text",title:"Filter",default:"*"},filetype:{type:"combo",title:"Read type",options:[{title:"Text",key:"text"},{title:"Base64 Encoded",key:"base64"},{title:"Object URL",key:"url"},{title:"Array buffer",key:"buffer"}],default:"text"},type:{type:"combo",title:"Force type",options:a,default:""},mime:{type:"text",title:"Force mime-type"},variable:{type:"text",title:"Temporary variable",default:"file"}}},string_general:{options:{type:"list",title:"For strings (general)"},fields:{askFilename:{type:"checkbox",title:"Ask for filename",options:{yes:"Yes"},default:[]}}},string:{options:{type:"table",multiple:!0,title:"For strings"},fields:{filter:{type:"combo",title:"filter on",options:[{title:"File extension",key:"ext"},{title:"Mime-type",key:"mime"}],default:"ext"},extension:{type:"text",title:"Filter",default:"*"},type:{type:"combo",title:"Force type",options:a,default:""},mime:{type:"text",title:"Force mime-type"},variable:{type:"text",title:"Temporary variable",default:"str"}}},photo:{options:{type:"table",multiple:!1,title:"For photos"},fields:{variable:{type:"text",title:"Temporary variable",default:"photo"}}}}}},j.prototype.configAliases={vartype:["groups","group",0,"vartype",0],label:["groups","group",0,"label",0],dragoverlabel:["groups","group",0,"dragoverlabel",0],hoverlabel:["groups","group",0,"hoverlabel",0],fileSelectLabel:["groups","group",0,"fileSelectLabel",0],labelFontSize:["groups","group",0,"labelFontSize",0],inputOptions:["groups","group",0,"inputOptions",0],vars:["groups","vars",0],string:["groups","string",0],photo:["groups","photo",0],showPhotoButton:["groups","group",0,"showPhotoButton",0],capture:["groups","group",0,"capture",0],checkOptions:["groups","group",0,"checkOptions",0],askFilename:["groups","string_general",0,"askFilename",0]},j.prototype.initImpl=function(){var b,c,d,e,f=this.module.getConfiguration("vars");if(f){var g=[];for(b=0,c=f.length;b<c;b++)d=f[b],e=a.extend({},d),g.push(e),e.match=d.extension?new RegExp(`^${d.extension.replace(/\*/g,".*").replace(/\?/g,".")}$`,"i"):/^.*$/i,d.filter||(e.filter="ext");this.fileCfg=g}var h=this.module.getConfiguration("string");if(h){var j=[];for(b=0,c=h.length;b<c;b++)d=h[b],e=a.extend({},d),j.push(e),e.match=d.filter?new RegExp(`^${d.extension.replace(/\*/g,".*").replace(/\?/g,".")}$`,"i"):/^text\/plain$/i,e.filetype="text";this.stringCfg=j,this.photoCfg=this.module.getConfiguration("photo")}this.resolveReady()},j.prototype.parseString=function(a,b){try{if(b.cfg.type)var c=e._parse(b.cfg.type,a);else c=a;this.tmpVar(c,b)}catch(b){f.info("Value could not be parsed: ",a,b)}},j.prototype.open=function(b){if(b.items&&b.items.length||b.files.length){var c,d=!0;for(let a=0;a<b.items.length;a++)"string"!==b.items[a].kind&&(d=!1);1===b.items.length&&(d=!1),c=d?k(b.items):b.items,this.module.model.tmpVars=new DataObject,this.module.model.tmpVarsArray=new DataObject;var e,f,g,h,j=[],m=this.fileCfg,n=this.stringCfg;if(!c)for(e=0;e<b.files.length;e++)f=b.files[e],h=a.Deferred(),j.push(h),(g=this.checkMetadata(f,m,l("application/octet-stream")))?(g.def=h,this.read(f,g)):h.resolve();else if(d){var g={};g.cfg=n,g.def=a.Deferred(),j.push(g.def),this.treatMultipleString(c,g)}else for(e=0;e<c.length;e++)f=c[e],h=a.Deferred(),j.push(h),"file"===f.kind?(f=f.getAsFile(),(g=this.checkMetadata(f,m,l("application/octet-stream")))?(g.def=h,this.read(f,g)):h.resolve()):(g={},g.cfg=n,g.def=h,this.treatString(f,g));a.when.apply(window,j).done(this.flushData)}},j.prototype.openPhoto=function(b){var c=this.checkPhotoMetadata(this.photoCfg);c.def=a.Deferred(),this.fileRead(b,c),c.def.done(this.flushData)},j.prototype.flushData=function(){this.createDataFromEvent("onRead","data",this.module.model.tmpVars),this.sendActionFromEvent("onRead","data",this.module.model.tmpVars),this.createDataFromEvent("onRead","dataarray",this.module.model.tmpVarsArray),this.sendActionFromEvent("onRead","dataarray",this.module.model.tmpVarsArray),this.module.model.tmpVars=new DataObject,this.module.model.tmpVarsArray=new DataObject},j.prototype.treatMultipleString=function(a,b){h.choose(a,{noConfirmation:!0,returnRow:!0,idField:"id",columns:[{id:"key",name:"content-type",field:"type"}]}).then(a=>("auto"===a.type&&(a.type=""),null==a?void b.def.resolve():void(a.getAsString=function(b){a.str.then(b)},this.treatString(a,b))))},j.prototype.treatString=function(a,b){var c=m(b.cfg);a.getAsString(d=>{if(this.module.getConfigurationCheckbox("askFilename","yes"))h.enterValue({description:c,label:"Enter filename",validationMessage:"Incorrect file extension",validation:c=>this.checkMetadata(a,b.cfg,l("text/plain"),c)}).then(c=>{if(null!=c){var e=this.checkMetadata(a,b.cfg,l("text/plain"),c);return e?void(Object.assign(b,e),this.parseString(d,b)):void b.def.resolve()}});else{var e=this.checkMetadata(a,b.cfg,l("text/plain"));if(!e)return void b.def.resolve();Object.assign(b,e),this.parseString(d,b)}})},j.prototype.checkMetadata=function(a,b,c,d){if(!b)return f.warn("No file filter configured");d=d||a.name||"";var e,g,j=a.type||c(d),k=d.split(".");e=2>k.length?"":k.pop().toLowerCase();for(var m,n=0,o=b.length;n<o;n++)if(m=b[n].filter,"ext"===m){var l=b[n].extension;if("*"===l||-1!==l.split(",").indexOf(e)){g=b[n];break}}else{var p=b[n].match;if(p.test(j)){g=b[n];break}}if(!g){var q=`Did not find match for ${d} (${j})`;return h.showNotification(q,"warn"),f.warn(q)}return{filename:d,mime:g.mime||j||"application/octet-stream",cfg:g}},j.prototype.checkPhotoMetadata=function(a){var b=a[0];return b.filetype="url",b.type="png",{mime:"image/png",cfg:b}},j.prototype.fileRead=function(a,b){switch(b.cfg.filetype){case"text":{this.parseString(a,b);break}case"base64":{const c=a.indexOf(";base64,");this.tmpVar(a.substr(c+8),b);break}case"url":case"buffer":{this.tmpVar(a,b);break}}},j.prototype.read=async function(a,b){if("image.png"===b.filename&&this.module.getConfigurationCheckbox("checkOptions","promptAmbiguous")){const c=await h.enterValue({label:"Enter image name (without file extension)",validationMessage:"Incorrect file extension",validation:b=>this.checkMetadata(a,this.fileCfg,"image/png",`${b}.png`)});if(null==c)return void b.def.resolve();b.filename=`${c}.png`}var c=new FileReader;switch(c.onload=a=>{this.fileRead(a.target.result,b)},c.onerror=a=>{f.error(a)},b.cfg.filetype){case"text":{c.readAsText(a);break}case"base64":case"url":{c.readAsDataURL(a);break}case"buffer":{c.readAsArrayBuffer(a);break}}},j.prototype.tmpVar=function(a,b){"object"!=typeof a&&b.cfg.type&&(a={type:b.cfg.type,value:a});var c=b.cfg.variable,d=new DataObject({encoding:b.cfg.filetype,filename:b.filename,mimetype:b.mime,contentType:b.mime,content:a});this.module.model.tmpVarsArray[c]||(this.module.model.tmpVarsArray[c]=new DataArray),this.module.model.tmpVarsArray[c].push(d),this.module.model.tmpVars[c]=d,b.def.resolve()},j.prototype.emulDataTransfer=function(a){for(var b={files:a.target.files,items:[]},c=0;c<a.target.files.length;c++)(function(c){b.items.push({kind:"file",getAsFile:function(){return a.target.files[c]}})})(c);return b},j});
