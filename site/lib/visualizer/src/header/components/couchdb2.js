define(["jquery","src/header/components/default","src/util/versioning","forms/button","src/util/util","lib/webtoolkit/base64","lib/couchdb/jquery.couch","fancytree","components/jquery-ui-contextmenu/jquery.ui-contextmenu.min"],function(a,b,c,d,e,f){function g(b,c){for(var d={},e=0;e<b.length;e++){var f=b[e],g=h(f);a.extend(!0,d,g)}return i(d,"",c)}function h(a){for(var b=a.value.flavors,c={},d=c,e=0;e<b.length-1;e++)d=d[b[e]]={__folder:!0};return d[b[b.length-1]]={__name:b.join(":"),__doc:a.doc,__data:a.value.data,__view:a.value.view},c}function i(a,b,c){var d,e;b.length?d=e=[]:(e=[{key:c,title:c,folder:!0,children:[]}],d=e[0].children,b=c+":");for(var f in a)if(0!==f.indexOf("__")){var g=a[f],h=b+f,j={title:f,key:h};g.__folder?(g.__name&&d.push({doc:g.__doc,hasData:g.__data,hasView:g.__view,lazy:!0,title:f,key:h}),j.folder=!0,j.children=i(g,h+":",c)):(j.lazy=!0,j.doc=g.__doc,j.hasData=g.__data,j.hasView=g.__view),d.push(j)}return e}function j(a,b){for(var c=a.join(":"),d=0,e=b.length;e>d;d++){var f=b[d].value.flavors.join(":");if(c===f)return!0}return!1}var k=function(){},l=/^[a-zA-Z0-9]+$/;return a.extend(k.prototype,b,{initImpl:function(){this.ok=this.loggedIn=!1,this.id=e.getNextUniqueId(),this.options.url&&(a.couch.urlPrefix=this.options.url.replace(/\/$/,"")),this.url=a.couch.urlPrefix;var b=this.options.database||"visualizer";this.database=a.couch.db(b),a.ui.fancytree.debugLevel=0,this.checkDatabase()},showError:function(a,b){var c,d="red";if(2===b&&(d="green"),"number"==typeof a)switch(a){case 10:c="Colons are not allowed in the name.";break;case 11:c="Please select a folder";break;case 12:c="A folder with this name already exists.";break;case 20:c="Document already has this flavor";break;case 21:c="Path already used by another document";break;case 401:c="Wrong username or password.";break;case 409:c="Conflict. An entry with the same name already exists.";break;case 503:c="Service Unavailable.";break;default:c="Unknown error."}else c=a;this.errorP.text(c).css("color",d).show().delay(3e3).fadeOut()},getFormContent:function(b){return a("#"+this.cssId(b)).val().trim()},setFormContent:function(b,c){a("#"+this.cssId(b)).val(c)},checkDatabase:function(){var b=this;a.couch.info({success:function(){b.ok=!0},error:function(a,b,c){console.error("CouchDB header : database connection error. Code:"+a+".",c)}})},cssId:function(a){return"ci-couchdb-header-"+this.id+"-"+a},changeFlavor:function(a){return l.test(a)?(this.flavor=a,this.setFormContent("flavor-input",a),void this.loadFlavor()):this.showError("Flavor name must be alphanumeric.")},_onClick:function(){this.ok?(this.setStyleOpen(this._open),this._open?(this.createMenu(),this.errorP.hide(),this.open()):this.close()):(this.checkDatabase(),console.error("CouchDB header : unreachable database."))},createMenu:function(){if(this.$_elToOpen)return void this.$_elToOpen.html(this.loggedIn?this.getMenuContent():this.getLoginForm());var b=this;this.$_elToOpen=a("<div>").css("width",550),this.errorP=a('<p id="'+this.cssId("error")+'">'),a.couch.session({success:function(a){null===a.userCtx.name?b.$_elToOpen.html(b.getLoginForm()):(b.loggedIn=!0,b.username=a.userCtx.name,b.$_elToOpen.html(b.getMenuContent()))}})},load:function(a,b){var d={};a.data.hasData&&(d.data={url:this.database.uri+a.data.doc._id+"/data.json"+(b?"?rev="+b:"")}),a.data.hasView&&(d.view={url:this.database.uri+a.data.doc._id+"/view.json"+(b?"?rev="+b:"")}),c.switchView(d,!0),this.lastKeyLoaded=a.key},save:function(b,d){if(!(d.length<1)){if(-1!==d.indexOf(":"))return this.showError(10);var e=c["get"+b+"JSON"](),g=this.lastNode;if("undefined"==typeof g)return this.showError(11);var h,i=g.node.findFirst(d),j=this;if(i&&i.title===d&&!i.folder&&g.node.getChildren().indexOf(i)>=0)h=i.data.doc,a.ajax({url:this.database.uri+h._id+"/"+b.toLowerCase()+".json?rev="+h._rev,type:"PUT",contentType:"application/json",data:e,dataType:"json",error:this.showError,success:function(a){h._rev=a.rev,i.data["has"+b]=!0,i.children&&i.lazyLoad(!0),j.showError(b+" saved.",2)}});else{var k={},l=[];g.key&&(l=g.key.split(":")),l.push(d),k[this.flavor]=l,h={_id:a.couch.newUUID(),flavors:k,name:this.username,_attachments:{}},h._attachments[b.toLowerCase()+".json"]={content_type:"application/json",data:f.encode(e)},this.database.saveDoc(h,{success:function(a){h._rev=a.rev;var c={doc:h,lazy:!0,title:d,key:g.node.key+":"+d};c["has"+b]=!0,g.node.addNode(c),g.node.expanded||g.node.toggleExpanded(),j.showError(b+" saved.",2)}})}}},mkdir:function(b){if(!(b.length<1)){if(-1!==b.indexOf(":"))return this.showError(10);var c=this.lastNode;if("undefined"==typeof c)return this.showError(11);var d;d=c.node.folder?c.node:c.node.parent;var e=d.getChildren();if(e)for(var f=0;f<e.length;f++)if(e[f].title===b&&e[f].folder)return this.showError(12);var g=d.addNode({folder:!0,title:b,key:d.key+":"+b});d.expanded||d.toggleExpanded(),a(g.li).find(".fancytree-title").trigger("click")}},login:function(b,c){var d=this;a.couch.login({name:b,password:c,success:function(){d.loggedIn=!0,d.username=b,d.$_elToOpen.html(d.getMenuContent())},error:function(){d.showError.apply(d,arguments)}})},logout:function(){var b=this;a.couch.logout({success:function(){b.loggedIn=!1,b.username=null,b.$_elToOpen.html(b.getLoginForm())}})},getLoginForm:function(){function b(){return c.login(c.getFormContent("login-username"),c.getFormContent("login-password")),!1}var c=this,e=this.loginForm=a("<div>");return e.append("<h1>Login</h1>"),e.append('<label for="'+this.cssId("login-username")+'">Username </label><input type="text" id="'+this.cssId("login-username")+'" /><br>'),e.append('<label for="'+this.cssId("login-password")+'">Password </label><input type="password" id="'+this.cssId("login-password")+'" />'),e.append(new d("Login",b,{color:"green"}).render()),e.bind("keypress",function(a){return 13===a.charCode?b():void 0}),e.append(this.errorP),e},getMenuContent:function(){var b=this,c=this.menuContent=a("<div>"),e=a("<div>").append(a("<p>").css("display","inline-block").css("width","50%").append("Click on an element to select it. Double-click to load.")).append(a("<p>").append("Logged in as "+this.username+" ").css("width","50%").css("text-align","right").css("display","inline-block").append(a("<a>Logout</a>").on("click",function(){b.logout()}).css({color:"blue","text-decoration":"underline",cursor:"pointer"})));c.append(e);var f=a('<input type="text" value="'+this.flavor+'" id="'+this.cssId("flavor-input")+'">');this.database.view("flavor/list",{success:function(a){b.flavorList=a.rows.length?a.rows[0].value:["default"],f.autocomplete({minLength:0,source:b.flavorList}).on("autocompleteselect",function(a,c){var d=c.item.value;b.flavor!==d&&b.changeFlavor(d)})},error:function(a){console.log(a)},key:this.username}),c.append(a("<p><span>Flavor : </span>").append(f).append(new d("Switch",function(){var a=b.getFormContent("flavor-input");b.flavor!==a&&b.changeFlavor(a)},{color:"red"}).render()));{var g={"overflow-y":"auto",height:"200px",width:"300px"};a("<div>").attr("id",this.cssId("tree")).css(g).appendTo(c)}return c.append(a("<p>").append('<input type="text" id="'+this.cssId("docName")+'"/>').append(new d("Save data",function(){b.save("Data",b.getFormContent("docName"))},{color:"red"}).render()).append(new d("Save view",function(){b.save("View",b.getFormContent("docName"))},{color:"red"}).render()).append(new d("Mkdir",function(){b.mkdir(b.getFormContent("docName"))},{color:"blue"}).render())),c.append(this.errorP),this.loadFlavor(),c},lazyLoad:function(b,c){var d=c.node.data.doc._id,e=a.Deferred();c.result=e.promise(),this.database.openDoc(d,{revs_info:!0,success:function(a){for(var b=a._revs_info,c=b.length,d=[],f=0;c>f;f++){var g=b[f];if("available"===g.status){var h={title:"rev "+(c-f),id:a._id,rev:!0,key:g.rev};d.push(h)}}e.resolve(d)}})},clickNode:function(b,c){var d,e,f,g=d=c.node,h=g.key.indexOf(":");if(f=h>=0?g.key.substring(h+1):"",g.folder){var i=f;e={name:this.username+(i.length>0?":"+i:""),node:g}}else{var j;g.data.rev&&(j=g.key,g=g.parent),d=g.parent,a("#"+this.cssId("docName")).val(g.title),e={name:g.data.doc._id,node:g},"fancytreedblclick"===b.type&&this.load(g,j)}return e={key:f,node:d},this.lastNode=e,"fancytreedblclick"!==b.type||g.folder?void 0:!1},loadFlavor:function(){var b=a.proxy(this,"lazyLoad"),c=a.proxy(this,"clickNode"),d=this,e={delegate:"span.fancytree-title",menu:[{title:"Delete",cmd:"delete",uiIcon:"ui-icon-trash"},{title:"New flavor",cmd:"newflavor",uiIcon:"ui-icon-newwin"},{title:"Rename",cmd:"rename",uiIcon:"ui-icon-folder-collapsed"}],beforeOpen:function(b,c){var d=a.ui.fancytree.getNode(c.target);return d.folder?!1:void d.setActive()},select:function(b,c){var e=a.ui.fancytree.getNode(c.target);d.contextClick(e,c.cmd)},createMenu:function(b){a(b.target).css("z-index",1e4)}},f={preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:300,dragStart:function(a){return a.folder?!1:!0},dragEnter:function(a){return a.folder?!0:!1},dragDrop:function(a,b){var c=b.otherNode;if(a===c.parent)return!1;var e=a.key.substring(d.flavor.length+1);e+=e.length?":"+c.title:c.title;var f=e.split(":");d.database.view("flavor/docs",{success:function(e){return j(f,e.rows)?d.showError(21):(c.data.doc.flavors[d.flavor]=f,void d.database.saveDoc(c.data.doc,{success:function(){c.moveTo(a,b.hitMode)},error:function(){d.showError.apply(d,arguments)}}))},error:function(a){console.log(a)},key:[d.flavor,d.username],include_docs:!1})}};this.database.view("flavor/docs",{success:function(h){var i=g(h.rows,d.flavor),j=a("#"+d.cssId("tree"));j.fancytree({extensions:["dnd"],dnd:f,source:[],lazyLoad:b,dblclick:c,debugLevel:0,activate:c}).children("ul").css("box-sizing","border-box");var k=j.data("ui-fancytree").getTree();k.reload(i),k.getNodeByKey(d.flavor).toggleExpanded(),j.contextmenu(e),d.lastKeyLoaded&&k.activateKey(d.lastKeyLoaded)},error:function(a){console.log(a)},key:[this.flavor,this.username],include_docs:!0})},contextClick:function(b,c){var d=this;b.folder||("delete"===c?(b.data.rev&&(b=b.parent),delete b.data.doc.flavors[this.flavor],a.isEmptyObject(b.data.doc.flavors)?(b.data.doc._deleted=!0,this.database.saveDoc(b.data.doc,{success:function(){d.showError("Document deleted.",2),b.remove()},error:function(){d.showError.apply(d,arguments)}})):this.database.saveDoc(b.data.doc,{success:function(){d.showError("Flavor deleted.",2),b.remove()},error:function(){d.showError.apply(d,arguments)}})):"rename"===c?a("<div>").html('New name : <input type="text" id="'+this.cssId("newname")+'" />').dialog({buttons:{Save:function(){var c=a(this),e=b.data.doc,f=d.getFormContent("newname"),g=e.flavors[d.flavor],h=g[g.length-1];g[g.length-1]=f,d.database.view("flavor/docs",{success:function(a){return j(g,a.rows)?(g[g.length-1]=h,d.showError(21)):void d.database.saveDoc(e,{success:function(){b.key=b.key.replace(/[^:]+$/,f),b.setTitle(f),c.dialog("destroy")},error:function(a){console.log(a)}})},error:function(a){console.log(a)},key:[d.flavor,d.username],include_docs:!1})},Cancel:function(){a(this).dialog("destroy")}},title:"New name"}):"newflavor"===c?a("<div>").html("Flavor :").dialog({buttons:{Save:function(){var c=a(this),e=b.data.doc,f=d.getFormContent("newflavorname");if(e.flavors[f])d.showError(20);else{var g=e.flavors[d.flavor];d.database.view("flavor/docs",{success:function(a){return j(g,a.rows)?d.showError(21):(e.flavors[f]=g,void d.database.saveDoc(e,{success:function(){d.showError("Flavor "+f+" successfully added.",2),c.dialog("destroy")},error:function(a){console.log(a)}}))},error:function(a){console.log(a)},key:[f,d.username],include_docs:!1})}},Cancel:function(){a(this).dialog("destroy")}},title:"New flavor"}).append(a('<input type="text" id="'+this.cssId("newflavorname")+'" />').autocomplete({minLength:0,source:d.flavorList})):console.warn('Context menu action "'+c+'" not implemented !'))}}),Object.defineProperty(k.prototype,"flavor",{get:function(){return this._flavor?this._flavor:this._flavor=window.sessionStorage.getItem("ci-visualizer-pouchdb2-flavor")||"default"},set:function(a){this._flavor=a,window.sessionStorage.setItem("ci-visualizer-pouchdb2-flavor",a)}}),k});