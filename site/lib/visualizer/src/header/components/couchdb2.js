"use strict";define(["jquery","lodash","src/util/api","src/util/ui","src/header/components/default","src/util/versioning","forms/button","src/util/util","forms/form","src/util/couchdbAttachments","src/util/uploadUi","src/util/debug","file-saver","lib/couchdb/jquery.couch","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/autocomplete"],function(a,b,c,d,e,f,g,h,i,j,k,l,m){function n(){}function o(b,c){for(var d={},e=0;e<b.length;e++){var f=b[e],g=p(f);a.extend(!0,d,g)}return q(d,"",c)}function p(a){for(var b=a.value.flavors,c={},d=c,e=0;e<b.length-1;e++)d=d[b[e]]={__folder:!0};return d[b[b.length-1]]={__name:b.join(":"),__doc:a.doc,__data:a.value.data,__view:a.value.view,__meta:a.value.meta,__public:a.value.isPublic},c}function q(a,b,c){var d,e;b.length?d=e=[]:(e=[{key:c,title:c,folder:!0,children:[]}],d=e[0].children,b=c+":");for(var f in a)if(0!==f.indexOf("__")){var g=a[f],h=b+f,i={title:f,key:h};g.__folder?(g.__name&&d.push({doc:g.__doc,hasData:g.__data,hasView:g.__view,hasMeta:g.__meta,isPublic:g.__public,lazy:!0,title:f,key:h}),i.folder=!0,i.children=q(g,h+":",c)):(i.lazy=!0,i.doc=g.__doc,i.hasData=g.__data,i.hasView=g.__view,i.hasMeta=g.__meta,i.isPublic=g.__public),d.push(i)}return e}function r(a,b){for(var c=a.join(":"),d=0,e=b.length;e>d;d++){var f=b[d].value.flavors.join(":");if(c===f)return!0}return!1}var s=h.getNextUniqueId(),t=/^[a-zA-Z0-9]+$/,u=52428800;return h.inherits(n,e,{initImpl:function(){var c=this;a(document).keydown(function(e){if((e.ctrlKey||e.metaKey)&&!e.altKey&&83==e.which){e.preventDefault();var g=f.lastLoaded.view.url,h=/\/([^\/]+)\/view\.json$/,i=h.exec(g),j=i[1],k=[];if(!c.ftree)return void d.showNotification("Cannot save, couchdb tree not loaded yet","info");if(c.ftree.visit(function(a){k.push(a)}),k=k.filter(function(a){return!a.folder&&a.data.doc&&a.data.doc._id===j}),!k.length)return;var l=b.template('<table>\n    <tr>\n        <td style="vertical-align: top;"><b>Document id</b></td>\n        <td><%= doc._id %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Flavor</b></td>\n        <td><%= flavor %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Name</b></td>\n        <td><% print(flavors[flavors.length-1]) %></td>\n    </tr>\n    <tr>\n        <td style="vertical-align: top;"><b>Location</b></td>\n        <td><li><% print(flavors.join(\'</li><li>\')) %></li></td>\n    </tr>\n</table>');d.dialog(l({doc:k[0].data.doc,flavor:c.flavor,flavors:k[0].data.doc.flavors[c.flavor]}),{width:"400px",buttons:{"Save View":function(){a(this).dialog("close"),c.saveNode("View",k[0]).then(function(){d.showNotification("View saved","success")},function(a){d.showNotification(c.getErrorContent(a.status),"error")})},"Save Data":function(){a(this).dialog("close"),c.saveNode("Data",k[0]).then(function(){d.showNotification("Data saved","success")},function(a){d.showNotification(c.getErrorContent(a.status),"error")})},"Save Both":function(){a(this).dialog("close"),c.saveNode("View",k[0]).then(function(){d.showNotification("View saved","success"),c.saveNode("Data",k[0]).then(function(){d.showNotification("Data saved","success")},function(a){d.showNotification(c.getErrorContent(a.status),"error")})},function(a){d.showNotification(c.getErrorContent(a.status),"error")})}}})}}),this.ok=this.loggedIn=this.ready=!1,this.options.beforeUrl?this.beforeUrl():this.ready=!0,this.id=h.getNextUniqueId(),this.options.loginMethods=this.options.loginMethods||["couchdb"],this.options.url&&(a.couch.urlPrefix=this.options.url.replace(/\/$/,"")),this.url=a.couch.urlPrefix;var e=this.db=this.options.database||"visualizer";this.dbUrl=this.url+"/"+e,this.database=a.couch.db(e),a.ui.fancytree.debugLevel=0,this.checkDatabase()},beforeUrl:function(){var b=this,c=this.options.beforeUrl;a.ajax({type:"GET",url:c,success:function(){l.info("CouchDB: beforeUrl success"),b.ready=!0},error:function(a){l.info("CouchDB: beforeUrl error",a),b.ready=!0}})},getErrorContent:function(a){var b;if("number"==typeof a)switch(a){case 10:b="Colons are not allowed in the name.";break;case 11:b="Please select a folder";break;case 12:b="A folder with this name already exists.";break;case 20:b="Document already has this flavor";break;case 21:b="Path already used by another document";break;case 401:b="Wrong username or password.";break;case 409:b="Conflict. An entry with the same name already exists.";break;case 503:b="Service Unavailable.";break;default:b="Unknown error."}else b=a;return b},showError:function(a,b){var c="red";2===b&&(c="green");var d=this.getErrorContent(a,b);this.errorP.text(d).css("color",c).show().delay(3e3).fadeOut()},getFormContent:function(b){return a("#"+this.cssId(b)).val().trim()},setFormContent:function(b,c){a("#"+this.cssId(b)).val(c)},checkDatabase:function(){var b=this;a.couch.info({success:function(a){b.ok=!0},error:function(a,b,c){l.error("CouchDB header : database connection error. Code:"+a+".",c)}})},cssId:function(a){return"ci-couchdb-header-"+this.id+"-"+a},changeFlavor:function(a){return t.test(a)?(this.flavor=a,this.setFormContent("flavor-input",a),void this.loadFlavor()):this.showError("Flavor name must be alphanumeric.")},_onClick:function(){this.ok&&this.ready?(this.setStyleOpen(this._open),this._open?(this.createMenu(),this.errorP.hide(),this.open()):this.close()):this.ok?d.showNotification("Couchdb button not ready"):(this.checkDatabase(),l.error("CouchDB header : unreachable database."))},createMenu:function(b){if(this.$_elToOpen||(this.$_elToOpen=a("<div>").css("width",560),this.errorP=a('<p id="'+this.cssId("error")+'">'),b=!0),b){var c=this;a.couch.session({success:function(a){null===a.userCtx.name?c.openMenu("login"):(c.loggedIn=!0,c.username=a.userCtx.name,c.openMenu("tree"))}})}else this.loggedIn?this.openMenu("tree"):this.openMenu("login")},openMenu:function(a){a!==this.lastMenu&&("tree"===a?(this.$_elToOpen.html(this.getMenuContent()),this.lastMenu="tree"):"login"===a&&(this.$_elToOpen.html(this.getLoginForm()),this.lastMenu="login"))},load:function(a,b){var c={};a.data.hasData&&(c.data={url:this.database.uri+a.data.doc._id+"/data.json"+(b?"?rev="+b:"")}),a.data.hasView&&(c.view={url:this.database.uri+a.data.doc._id+"/view.json"+(b?"?rev="+b:"")}),f.switchView(c,!0,{withCredentials:!0}),this.lastKeyLoaded=a.key},saveMeta:function(a){var b=this,c=b.currentDocument,d=c.data.doc;a&&a.keywords&&a.keywords.value&&(d.keywords=a.keywords.value),d._attachments["meta.json"]={content_type:"application/json",data:btoa(unescape(encodeURIComponent(JSON.stringify(a))))},b.database.saveDoc(d,{success:function(a){d._rev=a.rev,c.data.hasMeta=!0,c.children&&c.load(!0),b.showError("meta saved.",2)},error:function(){b.showError.apply(b,arguments)}})},saveNode:function(a,b){var c=this;if(!b){var d="Cannot save node (undefined)";return this.showError(d),Promise.reject(d)}var e=b.data.doc,g=f["get"+a+"JSON"]();return e._attachments[a.toLowerCase()+".json"]={content_type:"application/json",data:btoa(unescape(encodeURIComponent(g)))},Promise.resolve(c.database.saveDoc(e,{success:function(){b.data["has"+a]=!0,b.children&&b.load(!0),c.showError(a+" saved.",2)},error:function(){c.showError.apply(c,arguments)}}))},save:function(a,b){if(!(b.length<1)){if(-1!==b.indexOf(":"))return this.showError(10);var c=f["get"+a+"JSON"](),d=this.lastNode;if("undefined"==typeof d)return this.showError(11);var e,g=d.node.getChildren();if(g)for(var h=0;h<g.length;h++)if(g[h].title===b){e=g[h];break}var i,j=this;if(e&&!e.folder)return i=e.data.doc,i._attachments[a.toLowerCase()+".json"]={content_type:"application/json",data:btoa(unescape(encodeURIComponent(c)))},Promise.resolve(j.database.saveDoc(i,{success:function(){e.data["has"+a]=!0,e.children&&e.load(!0),j.showError(a+" saved.",2)},error:function(){j.showError.apply(j,arguments)}}));var k={},l=[];d.key&&(l=d.node.key.split(":"),l.shift()),l.push(b),k[this.flavor]=l,i={flavors:k,name:this.username,_attachments:{}},i._attachments[a.toLowerCase()+".json"]={content_type:"application/json",data:btoa(unescape(encodeURIComponent(c)))},this.database.saveDoc(i,{success:function(c){i._id=c.id,i._rev=c.rev;var e={doc:i,lazy:!0,title:b,key:d.node.key+":"+b};e["has"+a]=!0,d.node.addNode(e),d.node.expanded||d.node.toggleExpanded(),j.showError(a+" saved.",2)}})}},mkdir:function(b){if(!(b.length<1)){if(-1!==b.indexOf(":"))return this.showError(10);var c=this.lastNode;if("undefined"==typeof c)return this.showError(11);var d;d=c.node.folder?c.node:c.node.parent;var e=d.getChildren();if(e)for(var f=0;f<e.length;f++)if(e[f].title===b&&e[f].folder)return this.showError(12);var g=d.addNode({folder:!0,title:b,key:d.key+":"+b});d.expanded||d.toggleExpanded(),a(g.li).find(".fancytree-title").trigger("click")}},login:function(b,c){var d=this;a.couch.login({name:b,password:c,success:function(a){d.loggedIn=!0,d.username=b,d.openMenu("tree")},error:function(){d.showError.apply(d,arguments)}})},logout:function(){var b=this,c=Promise.resolve(a.couch.logout({success:function(){b.loggedIn=!1,b.username=null,b.openMenu("login")}}));c.catch(function(a){401===a.status&&(window.location=window.location.href)})},renderLoginMethods:function(){function b(){return c.login(c.getFormContent("login-username"),c.getFormContent("login-password")),!1}for(var c=this,d=this.openLogin.bind(this),e=0;e<this.options.loginMethods.length;e++)switch(this.options.loginMethods[e]){case"google":a('<a href=" '+this.url+'/auth/google">Google login</a><br/>').appendTo(this.loginForm).on("click",d);break;case"github":a('<a href=" '+this.url+'/auth/github">Github login</a><br/>').appendTo(this.loginForm).on("click",d);break;case"facebook":a('<a href=" '+this.url+'/auth/facebook">Facebook login</a><br/>').appendTo(this.loginForm).on("click",d);break;case"couchdb":this.loginForm.append("<div> Couchdb Login </div>"),this.loginForm.append('<label for="'+this.cssId("login-username")+'">Username </label><input type="text" id="'+this.cssId("login-username")+'" /><br>'),this.loginForm.append('<label for="'+this.cssId("login-password")+'">Password </label><input type="password" id="'+this.cssId("login-password")+'" /><br><br>'),this.loginForm.append(new g("Login",b,{color:"green"}).render()),this.loginForm.bind("keypress",function(a){return 13===a.charCode?b():void 0})}},openLogin:function(a){a.preventDefault();var b=a.currentTarget.href,c=window.open(b+"?close=true","CI_Couch_Login","menubar=no");clearInterval(this._loginWinI);var d=this;this._loginWinI=window.setInterval(function(){c.closed&&(d.createMenu(!0),clearInterval(d._loginWinI))},100)},getLoginForm:function(){var b=this.loginForm=a("<div>");return b.append("<h1>Login</h1>"),this.renderLoginMethods(),b.append(this.errorP),b},getMenuContent:function(){function e(){var a=h.getFormContent("flavor-input");h.flavor!==a&&h.changeFlavor(a)}function f(){if(h.currentDocument){var a=h.dbUrl+"/"+h.currentDocument.data.doc._id,d=new j(a);d.fetchList().then(function(e){k.uploadDialog(e,{mode:"couch",docUrl:a}).then(function(a){if(a){c.loading(s,"Uploading files...");var e;e=b.partition(a,function(a){return a.toDelete});var f=e[0];e=b.partition(e[1],function(a){return a.size<u});var g=e[1],i=e[0];i.sort(function(a,b){return a.size<b.size?1:a.size===b.size?0:-1});var j,k=[],l=[],m=0;for(j=0;j<i.length;j++)m+=i[j].size,u>m?l.push(i[j]):(k.push(l),l=[i[j]],m=i[j].size);l.length&&k.push(l);var n=Promise.resolve();for(n=n.then(function(){return d.remove(b.map(f,"name"))}),j=0;j<g.length;j++)!function(a){n=n.then(function(){return d.upload(g[a])})}(j);for(j=0;j<k.length;j++)!function(a){n=n.then(function(){return d.inlineUploads(k[a])})}(j);n.then(function(){c.stopLoading(s),h.showError("Files uploaded successfully",2)},function(a){c.stopLoading(s),h.showError("Files upload failed (at least partially)"),console.error(a.message,a.stack)}),n.then(function(){h.loadFlavor()})}})})}}var h=this,i=this.menuContent=a("<div>"),m=a("<div>").append(a("<p>").css("display","inline-block").css("width","50%").append("Click on an element to select it. Double-click to load.")).append(a("<p>").append("Logged in as "+this.username+" ").css("width","50%").css("text-align","right").css("display","inline-block").append(a("<a>Logout</a>").on("click",function(){h.logout()}).css({color:"blue","text-decoration":"underline",cursor:"pointer"})));i.append(m);var n=a('<input type="text" value="'+this.flavor+'" id="'+this.cssId("flavor-input")+'">');this.database.view("flavor/list",{success:function(a){a.rows.length?h.flavorList=a.rows[0].value:h.flavorList=["default"],n.autocomplete({appendTo:"#ci-visualizer",minLength:0,source:h.flavorList}).on("autocompleteselect",function(a,b){var c=b.item.value;h.flavor!==c&&h.changeFlavor(c),n.blur()}).on("keypress",function(a){13===a.keyCode&&(e(),n.blur())})},error:function(a){l.warn(a)},key:this.username}),i.append(a("<p><span>Flavor : </span>").append(n).append(new g("Switch",e,{color:"red"}).setTooltip("Switch flavor!").render()));var o={"overflow-y":"auto",height:"200px",width:"300px"};a("<div>").attr("id",this.cssId("tree")).css(o).appendTo(i);return this.makePublicButton=new g("Make Public",function(){d.confirm("You are about to make your view public. This action is irreversible. It will enable anybody to access the saved view and data. Do you want to proceed?","Proceed","Cancel").then(function(a){if(a&&h.currentDocument){var b=h.currentDocument,c=b.data.doc;c.isPublic=!0,h.database.saveDoc(c,{success:function(a){c._rev=a.rev,b.data.isPublic=!0,h.updateButtons(),b.children&&b.load(!0),h.showError("The view was made public",2)},error:function(){h.showError.apply(h,arguments)}})}})},{color:"red"}),i.append(a('<div style="width:560px; height:35px;">').append('<input type="text" id="'+this.cssId("docName")+'"/>').append(new g("Edit Meta",function(){h.metaData()},{color:"blue"}).render()).append(new g("Save data",function(){h.save("Data",h.getFormContent("docName"))},{color:"red"}).render()).append(new g("Save view",function(){h.save("View",h.getFormContent("docName"))},{color:"red"}).render()).append(new g("Mkdir",function(){h.mkdir(h.getFormContent("docName"))},{color:"blue"}).render()).append(this.errorP)),i.append("<hr>").append(this.makePublicButton.render().hide()).append(new g("Upload",f,{color:"green"}).render()),this.loadFlavor(),i},updateButtons:function(){var a=this.currentDocument,b=this.makePublicButton.getDom();a&&a.data&&!a.data.isPublic&&b?b.show():b&&b.hide()},getMetaForm:function(b){var c=this,d=b.data.doc;return new Promise(function(b){a.ajax({url:c.database.uri+d._id+"/meta.json",type:"GET",dataType:"json",error:function(a){l.warn("Could not get meta data...",a),b({})},success:function(a){b(c.processMetaForm(a))}})})},processMetaForm:function(a){var b={sections:{metadata:[{sections:{keywords:[]}}]}};for(var c in a){var d={};d.contentType=[a[c].type],d.keyword=[c],"text"===a[c].type?(d.contentText=[a[c].value],d.contentHtml=[""]):"html"===a[c].type&&(d.contentHtml=[a[c].value],d.contentText=[""]),b.sections.metadata[0].sections.keywords.push({sections:{},groups:{group:[d]}})}return b},metaData:function(){var a=this;if(!this.currentDocument)return void a.showError("No document selected");var b=d.dialog({width:"80%",autoPosition:!0,title:"Edit Metadata"}),c={sections:{metadata:{options:{title:"Metadata",icon:"info_rhombus"},sections:{keywords:{options:{multiple:!0,title:"Key/Value Metadata"},groups:{group:{options:{type:"list",multiple:!0},fields:{contentType:{type:"combo",options:[{key:"text",title:"Text"},{key:"html",title:"html"}],title:"Content type",displaySource:{text:"t",html:"h"},default:"text"},keyword:{type:"text",title:"Key"},contentText:{type:"jscode",mode:"text",title:"Value",displayTarget:["t"]},contentHtml:{type:"wysiwyg",title:"Value",default:" ",displayTarget:["h"]}}}}}}}}},e=new i({});e.init({onValueChanged:function(a){}}),e.setStructure(c),e.onStructureLoaded().done(function(){var b;b=a.currentDocument.data.hasMeta?a.getMetaForm(a.currentDocument):Promise.resolve({}),b.then(function(a){e.fill(a)})}),e.addButton("Cancel",{color:"blue"},function(){b.dialog("close")}),e.addButton("Save",{color:"green"},function(){var c=e.getValue();a.saveMeta(a.getMetaFromForm(c)),b.dialog("close")}),e.onLoaded().done(function(){b.html(e.makeDom(1,0)),e.inDom()})},getMetaFromForm:function(a){a=DataObject.check(a,!0);var b={},c=a.getChildSync(["sections","metadata",0,"sections","keywords"]);if(c)for(var d=0;d<c.length;d++){var e=c.getChildSync([d,"groups","group",0]);"text"===e.contentType[0]?b[e.keyword[0]]={type:"text",value:e.contentText[0]}:"html"===e.contentType[0]&&(b[e.keyword[0]]={type:"html",value:e.contentHtml[0]})}return b},lazyLoad:function(b,c){var d=c.node.data.doc._id,e=a.Deferred();c.result=e.promise(),this.database.openDoc(d,{revs_info:!0,success:function(a){for(var b=a._revs_info,d=b.length,f=[],g=0;d>g;g++){var h=b[g];if("available"===h.status){var i={title:"rev "+(d-g),id:a._id,rev:h.rev,key:c.node.key};f.push(i)}}e.resolve(f)}})},clickNode:function(b,c){var d,e,f,g=d=c.node,h=g.key.indexOf(":");if(f=h>=0?g.key.substring(h+1):"",g.folder)this.currentDocument=null;else{var i;g.data.rev&&(i=g.data.rev,g=g.parent),d=g.parent,this.currentDocument=g,a("#"+this.cssId("docName")).val(g.title),this.updateButtons(),"fancytreedblclick"===b.type&&this.load(g,i)}return e={key:f,node:d},this.lastNode=e,"fancytreedblclick"!==b.type||g.folder?void 0:!1},loadFlavor:function(){var c=a.proxy(this,"lazyLoad"),d=a.proxy(this,"clickNode"),e=this,f={delegate:"span.fancytree-title",menu:[{title:"Delete",cmd:"delete",uiIcon:"ui-icon-trash"},{title:"New flavor",cmd:"newflavor",uiIcon:"ui-icon-newwin"},{title:"Rename",cmd:"rename",uiIcon:"ui-icon-folder-collapsed"},{title:"Flavors",cmd:"flavors",children:[]}],beforeOpen:function(b,c){var d=a.ui.fancytree.getNode(c.target);if(d.folder)return!1;var f=a("#"+e.cssId("tree")),g=Object.keys(d.data.doc.flavors);if(1===g.length)f.contextmenu("setEntry","delete","Delete"),f.contextmenu("showEntry","flavors",!1);else{for(var h=new Array(g.length),i=0;i<g.length;i++)h[i]={title:g[i],cmd:"flavor"},g[i]===e.flavor&&(h[i].disabled=!0);f.contextmenu("setEntry","delete","Delete flavor"),f.contextmenu("setEntry","flavors",{title:"Flavors",children:h}),f.contextmenu("showEntry","flavors",!0)}d.setActive()},select:function(b,c){var d=a.ui.fancytree.getNode(c.target);e.contextClick(d,c.cmd,c)},createMenu:function(b){a(b.target).css("z-index",1e4)}},g={preventVoidMoves:!0,preventRecursiveMoves:!0,autoExpandMS:300,dragStart:function(a){return!a.folder&&!a.data.rev},dragEnter:function(a){return!!a.folder},dragDrop:function(a,b){var c=b.otherNode;if(a===c.parent)return!1;var d=a.key.substring(e.flavor.length+1);d+=d.length?":"+c.title:c.title;var f=d.split(":");e.database.view("flavor/docs",{success:function(d){return r(f,d.rows)?e.showError(21):(c.data.doc.flavors[e.flavor]=f,void e.database.saveDoc(c.data.doc,{success:function(){c.moveTo(a,b.hitMode)},error:function(){e.showError.apply(e,arguments)}}))},error:function(a){l.warn(a)},key:[e.flavor,e.username],include_docs:!1})}};this.database.list("flavor/sort","docs",{key:[this.flavor,this.username],include_docs:!0},{success:function(h){var i=o(h,e.flavor),j=a("#"+e.cssId("tree"));j.fancytree({toggleEffect:!1,extensions:["dnd"],dnd:g,source:[],lazyLoad:c,dblclick:d,debugLevel:0,activate:d}).children("ul").css("box-sizing","border-box");var k=j.data("ui-fancytree").getTree();if(e.ftree=k,k.reload(i),k.getNodeByKey(e.flavor).toggleExpanded(),j.contextmenu(f),e.lastKeyLoaded&&k.activateKey(e.lastKeyLoaded),e.currentDocument){var l=e.currentDocument.data.doc._id,m=b.find(h,function(a){return a.id===l});if(m){var n=b.flatten([e.flavor,m.value.flavors]).join(":");k.activateKey(n)}}},error:function(a){l.warn(a)}})},contextClick:function(b,c,e){var f=this;if(!b.folder)if("delete"===c)b.data.rev&&(b=b.parent),delete b.data.doc.flavors[this.flavor],a.isEmptyObject(b.data.doc.flavors)?(b.data.doc._deleted=!0,this.database.saveDoc(b.data.doc,{success:function(){f.showError("Document deleted.",2),b.remove()},error:function(){f.showError.apply(f,arguments)}})):this.database.saveDoc(b.data.doc,{success:function(){f.showError("Flavor deleted.",2),b.remove()},error:function(){f.showError.apply(f,arguments)}});else if("rename"===c)d.dialog('New name : <input type="text" id="'+this.cssId("newname")+'" value="'+b.title+'" />',{buttons:{Save:function(){var c=a(this),d=b.data.doc,e=f.getFormContent("newname"),g=d.flavors[f.flavor],h=g[g.length-1];g[g.length-1]=e,f.database.view("flavor/docs",{success:function(a){return r(g,a.rows)?(g[g.length-1]=h,f.showError(21)):void f.database.saveDoc(d,{success:function(){b.key=b.key.replace(/[^:]+$/,e),b.setTitle(e),c.dialog("destroy"),f.setFormContent("docName",e)},error:function(a){l.warn(a)}})},error:function(a){l.warn(a)},key:[f.flavor,f.username],include_docs:!1})},Cancel:function(){a(this).dialog("destroy")}}});else if("newflavor"===c){var g=a("<div>").html("Flavor :");d.dialog(g,{buttons:{Save:function(){var c=a(this),d=b.data.doc,e=f.getFormContent("newflavorname");if(d.flavors[e])f.showError(20);else{var g=d.flavors[f.flavor];f.database.view("flavor/docs",{success:function(a){return r(g,a.rows)?f.showError(21):(d.flavors[e]=g,void f.database.saveDoc(d,{success:function(){f.showError("Flavor "+e+" successfully added.",2),c.dialog("destroy")},error:function(a){l.warn(a)}}))},error:function(a){l.warn(a)},key:[e,f.username],include_docs:!1})}},Cancel:function(){a(this).dialog("destroy")}},title:"New flavor"}),g.append(a('<input type="text" id="'+this.cssId("newflavorname")+'" />').autocomplete({appendTo:"#ci-visualizer",minLength:0,source:f.flavorList}))}else"flavor"===c?f.changeFlavor(e.item.text()):"flavors"===c||l.warn('Context menu action "'+c+'" not implemented !')}}),Object.defineProperty(n.prototype,"flavor",{get:function(){return this._flavor?this._flavor:this._flavor=window.sessionStorage.getItem("ci-visualizer-pouchdb2-flavor")||"default"},set:function(a){this._flavor=a,window.sessionStorage.setItem("ci-visualizer-pouchdb2-flavor",a)}}),n});