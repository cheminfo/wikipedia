'use strict';define(["jquery","src/header/components/default","src/util/versioning","forms/button","src/util/util","fancytree","components/ui-contextmenu/jquery.ui-contextmenu.min","jquery-ui/ui/widgets/dialog"],function(a,b,c,d,e){"use strict";function f(){}function g(a){return a.map(function(a){return{title:a.name,folder:a.isDir,lazy:a.isDir,key:a.rel+a.name,data:{url:a.url,path:a.rel+a.name,dir:a.rel}}})}function h(b){return new Promise(function(c){var d=a("#ci-dialog");0===d.length&&(d=a("<div/>").css("id","ci-dialog"),a("body").append(d)),d.html(b),d.dialog({modal:!0,buttons:{Cancel:function(){a(this).dialog("close")},Ok:function(){c(!0),a(this).dialog("close")}},close:function(){return c(!1)},width:400})})}return e.inherits(f,b,{initImpl:function(){var b=this;this.id=e.getNextUniqueId(),a.ui.fancytree.debugLevel=0,a(document).keydown(function(a){if((a.ctrlKey||a.metaKey)&&83==a.which)return a.preventDefault(),b.checkNode(),b.save(),!1})},_onClick:function(){this.createMenu()},createMenu:function(){var b=this;this.$_elToOpen||(this.$_elToOpen=a("<div/>").css("width",550)),this.setStyleOpen(this._open),this._open?(!this.$tree&&(this.$tree=this.$tree||a("<div/>").css("id",this.cssId("tree")).css("display","inline-block").css("margin-right",20),this.$_elToOpen.append("<div><p><label>Filter:</label><input name=\"search\" placeholder=\"Filter...\"><button id=\"btnResetSearch\" disabled=\"disabled\">\xD7</button><span id=\"matches\"></span></p></div>"),this.$_elToOpen.append(this.$tree)),this.open(),this.initTree().then(function(){b.createButtons()})):this.close()},cssId:function(a){return`ci-navview-header-${this.id}-${a}`},reloadTree:function(){this.$tree.fancytree("destroy"),this.initTree(!0)},reloadActiveNode:function(){this.reloadNode(this.$tree.fancytree("getActiveNode"))},reloadNode:function(a){if(a.isFolder()||(a=a.getParent()),a.isRoot())return void this.reloadTree();var b=a.isExpanded();a.load(!0).then(function(){b&&a.setExpanded(!0,{noAnimation:!0})})},getDir:function(a){return a.replace(new RegExp(/\/[^/]+$/),"/")},load:function(){},save:function(){var b,d,e=this;if(this.activeNode)b=this.getDir(this.activeNode.data.path),d=this.activeNode.title;else if(this.viewURL){b=this.getDir(this.viewURL),b=b.replace(/^\/views/,".");var f=this.viewURL.lastIndexOf("/");d=-1<f?this.viewURL.slice(f+1):this.viewURL}else return;h(`You are about to save the current view to: ${b}${d}<br/>This operation will erase the previous content of this file and cannot be undone.`).then(function(f){if(f){var g=a.ajax({url:"/navview/save",data:{dir:b,name:d,content:c.getViewJSON("\t")},type:"POST",dataType:"json"});g.done(function(){e.log("success-log","Successfully saved view"),e.reloadActiveNode()}),g.fail(function(){e.log("error-log","Failed to save view")})}})},mkdir:function(){var b=this,c=this.activeNode.data.path;this.activeNode.isFolder()||(c=this.getDir(c));var d=this.getFormContent(this.$dirnameInput);if(c&&d){var e=a.ajax({url:"/navview/mkdir",type:"POST",data:{dir:c,name:d},dataType:"json"});e.done(function(){b.log("success-log","Successfully created directory"),b.reloadActiveNode()}),e.fail(function(){b.log("error-log","Failed create directory")})}},remove:function(b){var c=this;if(b.isFolder())return this.log("error-log","Failed remove file");var d=this.getDir(b.data.path),e=b.title;h(`<p>You are about to remove the file: <br/>${b.data.path}</p>Do you really want to do this? You cannot undo this operation`).then(function(f){if(f){var g=a.ajax({url:"/navview/file",type:"DELETE",data:{dir:d,name:e},dataType:"json"});g.done(function(){b.remove(),c.log("success-log","Successfully removed file")}),g.fail(function(){c.log("error-log","Failed remove file")})}})},removeDir:function(b){var c=this;return b.isFolder()?void h(`<p>You are about to remove the directory: <br/>${b.data.path}</p>Do you really want to do this? You cannot undo this operation`).then(function(d){if(d){var e=a.ajax({url:"/navview/dir",type:"DELETE",data:{dir:b.data.path},dataType:"json"});e.done(function(){b.remove(),c.log("success-log","Successfully removed directory")}),e.fail(function(){c.log("error-log","Failed remove directory")})}}):this.log("error-log","Failed remove directory")},rename:function(){var a=this,b=new RegExp(/(^.*)\/([^/]+$)/),c=b.exec(this.activeNode.data.path);if(3===!c.length)return void this.log("error-log","Invalid path...");var d=c[1],e=this.getFormContent("docName"),f=c[2],g=this.ajaxRename({dir:d,newDir:d,name:f,newName:e});g.done(function(){a.log("success-log","Successfully renamed file"),a.reloadActiveNode()}),g.fail(function(){a.log("error-log","Failed to rename file")})},ajaxRename:function(b){return a.ajax({url:"/navview/rename",type:"PUT",data:b,dataType:"json"})},inlineRename:function(a){var b=this,c={dir:a.data.dir,newDir:a.data.dir,newName:a.title,name:b.inlineOldTitle},d=this.ajaxRename(c);d.done(function(){a.setTitle(a.title),b.log("success-log","Successfully renamed file")}),d.fail(function(){a.setTitle(b.inlineOldTitle),b.log("error-log","Failed to rename file")})},newFile:function(){var b=this,c=b.activeNode.data.path;b.activeNode.isFolder()||(c=b.getDir(c));var d=a.ajax({url:"/navview/touch",type:"POST",data:{dir:c,name:b.getFormContent(this.$filenameInput)},dataType:"json"});d.done(function(){b.log("success-log","File successfully created"),b.reloadActiveNode()}),d.fail(function(){b.log("error-log","Failed to create new file")})},duplicate:function(){},checkNode:function(){this.activeNode||this.log("error-log","Error: you must select a node");var a=location.search.split("viewURL=")[1];a=decodeURIComponent(a),this.viewURL=a},log:function(a,b){if(this.$log){var c=this.$log.find(`#${this.cssId(a)}`);0<c.length&&(this.currentLogTimeout&&clearTimeout(this.currentLogTimeout),this.$log.find("div").html(""),c.html(b)),this.currentLogTimeout=setTimeout(function(){c.html("")},5e3)}},loadRootTree:function(){return this.treeSchema?this.treeSchema:a.ajax({url:"/navview/list",dataType:"json"})},initTree:function(b){var d=this;return!b&&d.fancytreeOk?Promise.resolve():this.loadRootTree().then(function(b){var e=g(b);d.$tree.fancytree({toggleEffect:!1,extensions:["edit","filter"],filter:{mode:"dimm"},source:e,lazyLoad:function(b,c){c.result=a.ajax({url:`/navview/list?dir=${c.node.data.path}`,dataType:"json"}).then(g)},activate:function(a,b){d.activeNode=b.node,d.updateSaveViewText()},dblclick:function(a,b){c.switchView({view:{url:b.node.data.url}},!0)},keydown:function(a,b){switch(a.preventDefault(),a.which){case 8:b.node.isFolder()?d.removeDir(b.node):d.remove(b.node);}},edit:{triggerStart:["f2","shift+click","mac+enter"],beforeEdit:function(a,b){return!b.node.isFolder()&&void(d.inlineOldTitle=b.node.title)},edit:function(){},beforeClose:function(){},save:function(b,c){return c.node.setTitle(c.input.val()),a(c.node.span).addClass("pending"),d.inlineRename(c.node),!0},close:function(b,c){c.save&&a(c.node.span).addClass("pending")}}}),d.fancytreeOk=!0;var f=d.$tree.fancytree("getTree");d.$_elToOpen.find("input[name=search]").keyup(function(b){var c,d=a(this).val();return b&&b.which===a.ui.keyCode.ESCAPE||""===a.trim(d)?void a("button#btnResetSearch").click():void(c=f.filterNodes(d,!1),a("button#btnResetSearch").attr("disabled",!1),a("span#matches").text(`(${c} matches)`))}).focus(),a("button#btnResetSearch").click(function(){a("input[name=search]").val(""),a("span#matches").text(""),f.clearFilter()}).attr("disabled",!0)})},createButtons:function(){var b=this;if(!this._buttons){this.$log=a("<div/>").attr("id",this.cssId("log")).css("margin-bottom",10),this.$_elToOpen.append("<div/>").children(":gt(1)").css("display","inline-block").css("vertical-align","top").append(this.$log),this.$log.append(a("<div/>").attr("id",this.cssId("error-log")).css("color","red")),this.$log.append(a("<div/>").attr("id",this.cssId("success-log")).css("color","green")),this.$log.parent().append(new d("Refresh Tree",function(){b.reloadTree()},{color:"blue"}).render()),this.$log.parent().append("<br/><br/><br/><div>\n    <ul>\n        <li style=\"color:black;\">Double-click a view to load it</li>\n        <li style=\"color: black;\">Shift+click to rename a view</li>\n        <li style=\"color: black;\">Press delete key to remove a view or a directory</li>\n    </ul>\n</div>");var c=a("<div>\n    <table>\n        <tr>\n            <td></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type=\"text\"/></td>\n            <td></td>\n        </tr>\n        <tr>\n            <td><input type=\"text\"/></td>\n            <td></td>\n        </tr>\n    </table>\n</div>");this.$_elToOpen.append(c);var e=c.find("input");this.$dirnameInput=a(e[0]),this.$filenameInput=a(e[1]);var f=c.find("td");this.$saveViewText=a(f[0]),a(f[1]).append(new d("Save view",function(){b.checkNode(),b.save()},{color:"red"}).render()),a(f[3]).append(new d("Mkdir",function(){b.checkNode(),b.mkdir()},{color:"blue"}).render()),a(f[5]).append(new d("New file",function(){b.checkNode(),b.newFile()},{color:"blue"}).render()),this._buttons=!0}},updateSaveViewText:function(){this.$saveViewText.html(this.activeNode.data.path)},getFormContent:function(b){return"string"==typeof b?a(`#${this.cssId(b)}`).val().trim():b instanceof jQuery?b.val().trim():void 0},setFormContent:function(b,c){a(`#${this.cssId(b)}`).val(c)}}),f});
