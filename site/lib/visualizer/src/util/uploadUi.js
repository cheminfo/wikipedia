'use strict';define(["src/util/util","src/util/debug","src/util/ui","lodash","jquery","slickgrid","mime-types"],function(a,b,c,d,e,f,g){"use strict";function h(a,b){for(var c,e=Array(a.length),f=0;f<a.length;f++)c=a[f],e[f]={name:c.name,contentType:c.content_type,size:c.length,toDelete:!1},b.docUrl&&(e[f].downloadUrl=`${b.docUrl}/${c.name}`);return e}function i(a,b){function c(a,b){return a<b?-1:b<a?1:0}a.onSort.subscribe(function(d,e){b.sort(c,e.sortAsc,function(a){return a[e.sortCol.field]}),a.invalidateAllRows(),a.render()})}function j(a,b,c,d,e){var f=e.name.replace(/^.*\//,"");return`<div style="width:100%; height: 100%;"><a href="${e.downloadUrl}" download="${f}" class="download-attachment"><i class="centered-icon fa fa-file-download"></i></a></div>`}var k={couchdb:h,couch:h},l={},m=Promise.all([a.loadCss("components/slickgrid/slick.grid.css"),a.loadCss("src/util/uploadUi.css")]);return l.uploadDialog=function(a,b){var h=b.mode;a&&h&&k[h]&&(a=k[h](a,b)),a=a||[];var l;return m.then(function(){return new Promise(function(b){function h(a,b){b=b||"";var c="upload/"+(""===b?a.name:`${b}/${a.name}`),e=d.find(l.getItems(),function(a){return a.name===c});e?(e.file=a,e.color="orange",e.size=a.size||e.size):l.addItem({name:c,file:a,contentType:a.type||g.lookup(c)||"application/octet-stream",size:a.size||0,toDelete:!1,color:"green"})}function k(a,b){return new Promise(function(c){a.file(function(a){h(a,b),c(a)})})}function m(a,b){return b=b||"",a.isDirectory?Promise.resolve().then(function(){var c=a.createReader();return new Promise(function(a){c.readEntries(function(c){for(var d,e=[],f=0;f<c.length;f++)d=c[f],d.isFile?e.push(k(d,b)):d.isDirectory&&e.push(m(d,`${b}/${d.name}`));return a(Promise.all(e))})})}):k(a)}var n={editable:!0,enableAddRow:!1,enableCellNavigation:!0,autoEdit:!0,enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:!0,multiColumnSort:!1,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,rowHeight:20},o=[{id:"name",name:"name",field:"name",sortable:!0},{id:"contentType",name:"contentType",field:"contentType",editor:f.Editors.Text,sortable:!0},{id:"size",name:"size",field:"size",sortable:!0},{id:"toDelete",name:"toDelete",field:"toDelete",width:40,editor:f.Editors.Checkbox,formatter:f.Formatters.Checkmark,sortable:!0}];a[0]&&a[0].downloadUrl&&o.push({id:"__download_attachment__",name:"Download",field:"__download_attachment__",sortable:!1,width:30,formatter:j});var p=e("<div class=\"upload-ui\">"),q=e("<div class=\"dropzone\">"),r=e("<input type=\"checkbox\">Select/Unselect Delete</input>");r.on("change",function(){var b=!!this.checked;a.forEach(function(a){("view.json"!==a.name||"data.json"===a.name||"meta.json"===a.name)&&(a.toDelete=b)}),s.invalidateAllRows(),s.render()});var s;c.dialog(p,{buttons:{Cancel:function(){e(this).dialog("close")},Upload:function(){var c=d.filter(a,function(a){return a.file||a.toDelete});b(c),e(this).dialog("close")}},close:function(){b(!1)},resize:function(){s.resizeCanvas()},open:function(){p.append(q),p.append(r),l=new f.Data.DataView,l.beginUpdate(),l.setItems(a,"name"),l.endUpdate(),s=new f.Grid(q,l,o,n),i(s,l)},closeOnEscape:!0,width:700,height:500});var t=0;p[0].addEventListener("dragenter",function(a){a.preventDefault(),a.stopPropagation(),t++,1==t&&q.addClass("drop-over")}),p[0].addEventListener("dragleave",function(a){a.preventDefault(),a.stopPropagation(),t--,t||q.removeClass("drop-over")}),p[0].addEventListener("dragover",function(a){a.preventDefault()}),p[0].addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),t=0,p.removeClass("drop-over");for(var b,c=[],d=0;d<a.dataTransfer.items.length;d++)b=a.dataTransfer.items[d].webkitGetAsEntry(),c.push(m(b,b.name));Promise.all(c).then(function(){s.invalidateAllRows(),s.render()})})})})},l});
