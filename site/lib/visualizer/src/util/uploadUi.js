"use strict";define(["src/util/util","src/util/debug","src/util/ui","lodash","jquery","slickgrid","mime-types"],function(a,b,c,d,e,f,g){function h(a){for(var b=new Array(a.length),c=0;c<a.length;c++){var d=a[c];b[c]={name:d.name,contentType:d.content_type,size:d.length,toDelete:!1}}return b}function i(a,b){a&&b&&j[b]&&(a=j[b](a));var h=new f.Data.DataView;return a=a||[],h.setItems(a,"name"),l.then(function(){return new Promise(function(b){function h(b,c){c=c||"";var e=m+(""===c?b.name:c+"/"+b.name),f=d.find(a,function(a){return a.name===e});f?(f.file=b,f.color="orange"):a.push({name:e,file:b,contentType:b.type||g.lookup(e)||"application/octet-stream",size:b.size||0,toDelete:!1,color:"green"})}function i(a,b){return new Promise(function(c){a.file(function(a){h(a,b),c(a)})})}function j(a,b){return b=b||"",a.isDirectory?Promise.resolve().then(function(){var c=a.createReader();return new Promise(function(a,d){c.readEntries(function(c){for(var d=[],e=0;e<c.length;e++){var f=c[e];f.isFile?d.push(i(f,b)):f.isDirectory&&d.push(j(f,b+"/"+f.name))}return a(Promise.all(d))})})}):i(a)}var k={editable:!0,enableAddRow:!1,enableCellNavigation:!0,autoEdit:!0,enableTextSelectionOnCells:!0,enableColumnReorder:!0,forceFitColumns:!0,multiColumnSort:!0,asyncEditorLoading:!0,asyncEditorLoadDelay:30,enableAsyncPostRender:!0,asyncPostRenderDelay:0,rowHeight:20},l=[{id:"name",name:"name",field:"name",sortable:!0},{id:"contentType",name:"contentType",field:"contentType",editor:f.Editors.Text,sortable:!0},{id:"size",name:"size",field:"size",sortable:!0},{id:"toDelete",name:"toDelete",field:"toDelete",editor:f.Editors.Checkbox,formatter:f.Formatters.Checkmark}],n=e('<div class="upload-ui">'),o=e('<div class="dropzone">'),p=e('<input type="checkbox">Select/Unselect Delete</input>');p.on("change",function(){var b=!!this.checked;a.forEach(function(a){("view.json"!==a.name||"data.json"===a.name||"meta.json"===a.name)&&(a.toDelete=b)}),q.invalidate(),q.render()});var q;c.dialog(n,{buttons:{Cancel:function(){e(this).dialog("close")},Upload:function(){var c=d.filter(a,function(a){return a.file||a.toDelete});b(c),e(this).dialog("close")}},close:function(){b(!1)},resize:function(){q.resizeCanvas()},open:function(){n.append(o),n.append(p),q=new f.Grid(o,a,l,k)},closeOnEscape:!0,width:700,height:500});var r=0;n[0].addEventListener("dragenter",function(a){a.preventDefault(),a.stopPropagation(),r++,1===r&&o.addClass("drop-over")}),n[0].addEventListener("dragleave",function(a){a.preventDefault(),a.stopPropagation(),r--,r||o.removeClass("drop-over")}),n[0].addEventListener("dragover",function(a){a.preventDefault()}),n[0].addEventListener("drop",function(a){a.stopPropagation(),a.preventDefault(),r=0,n.removeClass("drop-over");for(var b=[],c=0;c<a.dataTransfer.items.length;c++){var d=a.dataTransfer.items[c].webkitGetAsEntry();b.push(j(d,d.name))}Promise.all(b).then(function(){q.updateRowCount(),q.render(),q.autosizeColumns()})})})})}var j={couchdb:h,couch:h},k={},l=Promise.all([a.loadCss("components/slickgrid/slick.grid.css"),a.loadCss("src/util/uploadUi.css")]),m="upload/";return k.uploadDialog=i,k});