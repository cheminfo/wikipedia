'use strict';define(["./util"],function(a){"use strict";function b(){return!0}function c(){return!1}const d="anonymousRead";class e{constructor(a,b){this.view=a,this.manager=b,this._revision=null}get content(){return this.view.$content}get creationDate(){return new Date(this.view.$creationDate)}get flavors(){return this.content.flavors}get flavorNumber(){return Object.keys(this.content.flavors).length}get id(){return this.view._id}get modificationDate(){return new Date(this.view.$modificationDate)}get owner(){return this.view.$owners[0]}get owners(){return this.view.$owners.slice(1).filter(a.isEmail)}get revid(){return this.view._rev}get size(){let a=0;const b=this.view._attachments;if(b)for(const c in b)a+=b[c].length||.75*b[c].data.length;return a}get title(){return this.content.title||""}get keywords(){return this.content.keywords||[]}get icon(){return this.content.icon}get name(){return this.content.name}get category(){return this.content.category}get version(){return this.content.version||"0.0.0"}get public(){return-1!==this.view.$owners.indexOf(d)}getPath(a){const b=this.flavors[a].slice(0,-1);return`/${b.join("/")}`}hasFlavor(a){return!!this.flavors[a]}hasView(){return this.view._attachments&&this.view._attachments["view.json"]}hasData(){return this.view._attachments&&this.view._attachments["data.json"]}getViewUrl(){var a=this._revision?`?rev=${this._revision}`:"";return this.hasView()?`${this.manager.rocDbUrl}/entry/${this.id}/view.json${a}`:null}getDataUrl(){var a=this._revision?`?rev=${this._revision}`:"";return this.hasData()?`${this.manager.rocDbUrl}/entry/${this.id}/data.json${a}`:null}getViewSwitcher(){return{view:{url:this.getViewUrl()},data:{url:this.getDataUrl()}}}moveTo(a){var d=a.data.path,e=d[0],f=this.flavors[e],g=f[f.length-1];return this.flavors[e]=d.slice(1).concat(g),this.save().then(b,c)}save(){const a=a=>(this.view._id=a.body.id,this.reload().catch(()=>{this.view._rev=a.body.rev,this.view.$modificationDate=a.body.$modificationDate,this.view.$creationDate=a.body.$creationDate}));return this.id?this.manager.putRequestDB(`/entry/${this.id}`,this.view).then(a):this.manager.postRequestDB("/entry/",this.view).then(a)}saveView(a){const c=this.title,d=this.version;let e;return this.hasView()&&(e=this.view._attachments["view.json"]),this.content.title=a.title,this.content.version=a.version,this.content.keywords=a.keywords,this.content.icon=a.icon,this.content.name=a.name,this.content.category=a.category,this.view._attachments||(this.view._attachments={}),this.view._attachments["view.json"]=a.attachment,this.save().then(b,()=>(this.content.title=c,this.content.version=d,e&&(this.view._attachments["view.json"]=e),!1))}remove(){const a=this.view.$deleted;return this.view.$deleted=!0,this.save().then(b,()=>("boolean"==typeof a&&(this.view.$deleted=a),!1))}getName(a){var b=this.flavors[a];return b[b.length-1]}rename(a,c){var d=this.flavors[a],e=d[d.length-1];return d[d.length-1]=c,this.save().then(b,function(){return d[d.length-1]=e,!1})}toggleFlavor(a,b){if(this.flavors[a]){if(1===this.flavorNumber)return Promise.resolve({state:"err-one"});const b=this.flavors[a];return delete this.flavors[a],this.save().then(()=>({state:"removed"}),()=>(this.flavors[a]=b,!1))}else{const c=this.flavors[b][this.flavors[b].length-1];return this.flavors[a]=[c],this.save().then(()=>({state:"added",name:c}),()=>(delete this.flavors[a],!1))}}addGroup(a){return this.manager.putRequestDB(`/entry/${this.id}/_owner/${a}`).then(()=>this.reload()).then(b,c)}removeGroup(a){return this.manager.deleteRequestDB(`/entry/${this.id}/_owner/${a}`).then(()=>this.reload()).then(b,c)}reload(){return this.manager.getRequestDB(`/entry/${this.id}`).then(a=>this.view=a.body)}togglePublic(){return-1===this.view.$owners.indexOf(d)?this.addGroup(d):this.removeGroup(d)}getRevisions(a){return this._revs&&!a?this._revs:(this._revs=this.manager.getRequestDB(`/entry/${this.id}`,{revs_info:!0}).then(a=>a.body._revs_info.filter(a=>"available"===a.status).map(a=>a.rev)),this._revs)}setRevision(a){this._revision=a}getRevisionData(a){return this.manager.getRequestDB(`/entry/${this.id}?rev=${a}`).then(a=>a.body)}}return e});
